<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard WhatsApp ‚Äì Cec√≠lia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Configura√ß√£o b√°sica do tema Tailwind (dark neon) -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bgDark: '#020617',      // fundo principal
            bgCard: '#020617',      // fundo dos cards
            bgCardSoft: '#020617',  // varia√ß√£o sutil
            accent: '#38bdf8',      // ciano neon
            accentSoft: '#0ea5e9',
            accentDanger: '#f97373', // vermelho suave
            textSoft: '#e5e7eb',
            textMuted: '#9ca3af',
            borderSoft: 'rgba(148,163,184,0.25)'
          },
          boxShadow: {
            neon: '0 0 25px rgba(56,189,248,0.35)'
          },
          borderRadius: {
            '2xl': '1rem',
            '3xl': '1.5rem'
          }
        }
      }
    };
  </script>
  <!-- Chart.js (para uso futuro; gr√°ficos ser√£o adicionados depois) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Fonte opcional: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Estilos adicionais do dashboard -->
  <style>
    :root {
      color-scheme: dark;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    /* Scrollbar mais discreta */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.4);
      border-radius: 999px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.7);
    }
    /* ========================================= */
    /*   ESTILOS COMPLETOS DO TEMA DARK/NEON     */
    /* ========================================= */

    .dash-grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 1rem;
    }

    /* CARD BASE */
    .dash-card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(248,250,252,0.02), transparent 60%),
                  #020617;
      border-radius: 1.25rem;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 1rem;
      position: relative;
      overflow: hidden;
    }

    .dash-card::before {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0;
      background: radial-gradient(circle at top, rgba(56,189,248,0.12), transparent 60%);
      transition: opacity 0.2s ease-out;
      pointer-events: none;
    }

    .dash-card:hover::before {
      opacity: 1;
    }

    .dash-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      gap: 0.75rem;
    }

    .dash-card-title {
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .dash-card-title span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #38bdf8;
      box-shadow: 0 0 8px rgba(56,189,248,0.9);
    }

    .dash-card-main-value {
      font-size: 1.8rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .dash-card-sub {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    /* TAG BADGES */
    .tag-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 0.12rem 0.6rem;
      font-size: 0.7rem;
      font-weight: 500;
      border-width: 1px;
      border-style: solid;
      white-space: nowrap;
      gap: 0.25rem;
    }

    .tag-badge span.count {
      font-variant-numeric: tabular-nums;
      opacity: 0.9;
    }

    /* TABELA */
    .dash-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .dash-table thead tr {
      border-bottom: 1px solid rgba(51,65,85,0.8);
    }

    .dash-table thead th {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      color: #9ca3af;
      padding: 0.35rem 0.3rem;
      text-align: left;
    }

    .dash-table tbody tr {
      border-bottom: 1px solid rgba(15,23,42,0.9);
    }

    .dash-table tbody tr:hover {
      background: rgba(15,23,42,0.95);
    }

    .dash-table tbody td {
      padding: 0.32rem 0.3rem;
      color: #e5e7eb;
      vertical-align: top;
    }

    .risk-pill {
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(248,113,113,0.08);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.6);
    }

    /* BOT√ÉO */
    .btn-soft {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.8rem;
      border: 1px solid rgba(148,163,184,0.55);
      color: #e5e7eb;
      background: rgba(15,23,42,0.9);
      gap: 0.4rem;
      cursor: pointer;
      transition: all 0.15s ease-out;
    }

    .btn-soft:hover {
      border-color: rgba(56,189,248,0.7);
      box-shadow: 0 0 18px rgba(56,189,248,0.35);
    }

    /* API STATUS DOT */
    .api-status-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      margin-right: 0.4rem;
      box-shadow: 0 0 8px rgba(56,189,248,0.9);
    }

    /* ============================ */
    /*   MODAL ESTILO WHATSAPP      */
    /* ============================ */

    .msg-modal-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .msg-modal {
      width: min(900px, 100%);
      max-height: min(85vh, 720px);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.14), transparent 65%),
                  #020617;
      border-radius: 1.5rem;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 0 40px rgba(15,23,42,0.95);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .msg-modal {
      width: min(900px, 100%);
      max-height: min(85vh, 720px);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.14), transparent 65%),
                  #020617;
      border-radius: 1.5rem;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 0 40px rgba(15,23,42,0.95);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
  </style>

  <!-- CryptoJS AES (Para prote√ß√£o por senha) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>


</head>

<body class="bg-bgDark text-textSoft">

  <!-- =============================== -->
  <!--  üîê TELA DE LOGIN (AES LOCK)     -->
  <!-- =============================== -->
  <div id="loginScreen" class="fixed inset-0 flex flex-col items-center justify-center bg-black z-50">
    
    <h1 class="text-xl font-bold text-purple-400 mb-6">
      Digite a senha para acessar!
    </h1>

    <!-- Campo de senha -->
    <div class="flex items-center mb-4">
      <input
        id="passwordInput"
        type="password"
        placeholder="Digite a senha..."
        class="px-4 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none"
      />

      <!-- Bot√£o "mostrar senha" -->
      <button
        onclick="togglePassword()"
        class="ml-2 px-3 py-2 bg-gray-700 rounded-lg text-sm hover:bg-gray-600"
      >
        üëÅ
      </button>
    </div>

    <!-- Bot√£o Entrar -->
    <button
      onclick="attemptLogin()"
      class="px-6 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-semibold"
    >
      Entrar
    </button>

    <!-- Feedback -->
    <div id="loginError" class="text-red-500 mt-4 hidden">
      Senha incorreta. Tente novamente.
    </div>
  </div>

  <!-- =============================== -->
  <!--  CONTE√öDO REAL DO DASHBOARD      -->
  <!--  (Fica escondido at√© login)      -->
  <!-- =============================== -->
  <div id="dashboardContent" class="hidden">

    <!-- TODO: As partes 2‚Äì10 v√£o preencher este bloco inteiro -->
    <!-- Cards, filtros, paineis, modais, etc. -->
  <script>
  const DASHBOARD_PASSWORD = "efgm3936";

  function togglePassword() {
    const input = document.getElementById("passwordInput");
    input.type = input.type === "password" ? "text" : "password";
  }

  function attemptLogin() {
    const input = document.getElementById("passwordInput").value.trim();
    const error = document.getElementById("loginError");

    if (input === DASHBOARD_PASSWORD) {
      // Oculta tela de login
      document.getElementById("loginScreen").classList.add("hidden");

      // Mostra dashboard
      document.getElementById("dashboardContent").classList.remove("hidden");
    } else {
      error.classList.remove("hidden");
    }
  }
</script>
<!-- ============================= -->
<!--  CABE√áALHO SUPERIOR           -->
<!-- ============================= -->
<header class="w-full bg-gray-900 border-b border-gray-700 mb-6 py-4 px-6 flex justify-between items-center">
  <div>
    <h1 class="text-2xl font-bold text-purple-400">Dashboard WhatsApp ‚Äî Cec√≠lia</h1>
    <p class="text-sm text-gray-400">Monitoramento em tempo real</p>
  </div>

  <div class="flex items-center space-x-4">
    
    <!-- Estado da API -->
    <div id="apiStatus" class="px-3 py-1 rounded-lg bg-gray-800 text-gray-300 text-sm">
      API: <span id="apiStatusText" class="text-yellow-400">Carregando...</span>
    </div>

    <!-- Bot√£o recarregar -->
    <button onclick="reloadDashboard()"
      class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm">
      Recarregar
    </button>
  </div>
</header>



<!-- ================================================== -->
<!--  GRID SUPERIOR ‚Äî CARDS GRANDES                     -->
<!-- ================================================== -->

<div class="grid grid-cols-1 md:grid-cols-4 gap-6 px-6 mb-8">

  <!-- CARD 1 ‚Äî MENSAGENS TOTAIS -->
  <div class="p-6 bg-gray-900 rounded-xl shadow-lg border border-gray-800">
    <h2 class="text-gray-400 text-sm mb-2">Total de Mensagens</h2>
    <div id="totalMessages" class="text-3xl font-bold text-purple-300">‚Äî</div>
    <p class="text-sm text-gray-500 mt-2">
      Mensagens registradas no hist√≥rico completo.
    </p>
  </div>



  <!-- CARD 2 ‚Äî HOJE -->
  <div class="p-6 bg-gray-900 rounded-xl shadow-lg border border-gray-800">
    <h2 class="text-gray-400 text-sm mb-2">Hoje</h2>

    <div class="text-3xl font-bold text-purple-300 mb-2">
      <span id="todaySent">‚Äî</span> enviadas<br>
      <span id="todayReceived">‚Äî</span> recebidas
    </div>

    <!-- √öltima mensagem registrada (migrada do card inferior) -->
    <p class="text-sm text-gray-400 mt-4">
      √öltima mensagem registrada:
    </p>
    <div id="lastMessage" class="text-sm text-gray-300 font-mono">‚Äî</div>
  </div>



  <!-- CARD 3 ‚Äî RISCOS ALTOS -->
  <div class="p-6 bg-gray-900 rounded-xl shadow-lg border border-gray-800">
    <h2 class="text-red-400 text-sm mb-2 font-semibold">
      Riscos Altos (IA)
    </h2>

    <div class="text-3xl font-bold text-red-400" id="highRiskTotal">
      ‚Äî
    </div>

    <p class="text-xs text-gray-400 mt-3 leading-snug">
      Este n√∫mero representa a soma dos scores de risco classificados pela IA
      como <span class="text-red-300">alto impacto emocional</span>, incluindo
      mensagens com labels como <em>depressivo</em>, <em>suicida</em> e 
      <em>agress√£o</em>.  
    </p>
  </div>



  <!-- CARD 4 ‚Äî STATUS DE TAGS / LEGENDA -->
  <div class="p-6 bg-gray-900 rounded-xl shadow-lg border border-gray-800">
    <h2 class="text-gray-400 text-sm mb-3">Legendas de TAGs (IA)</h2>

    <div class="flex flex-wrap gap-2 text-xs">
      <span class="px-2 py-1 rounded bg-red-900 text-red-300">suicida</span>
      <span class="px-2 py-1 rounded bg-red-800 text-red-200">depressivo</span>
      <span class="px-2 py-1 rounded bg-yellow-900 text-yellow-300">bullying</span>
      <span class="px-2 py-1 rounded bg-orange-900 text-orange-300">agress√£o</span>
      <span class="px-2 py-1 rounded bg-blue-900 text-blue-300">apoio_positivo</span>
      <span class="px-2 py-1 rounded bg-purple-900 text-purple-300">controle_ciumento</span>
      <span class="px-2 py-1 rounded bg-green-900 text-green-300">conselho</span>
      <!-- neutro e ignorado removidos -->
    </div>
  </div>

</div> <!-- fim da grid superior -->


<!-- ================================================ -->
<!--  IN√çCIO DO CONTAINER PRINCIPAL DE PAINEIS        -->
<!-- ================================================ -->

<div class="px-6 pb-20">

<!-- PAINEIS VIR√ÉO AQUI NAS PARTES 3‚Äì10 -->
<!-- ================================================ -->
<!--   LINHA DOS CARDS DE MONITORAMENTO / IMPACTO     -->
<!-- ================================================ -->

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">


  <!-- ============================ -->
  <!--   CARD ‚Äî MONITORAMENTO FERNANDO -->
  <!-- ============================ -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <h2 class="text-gray-400 text-sm mb-3">
      Monitoramento ‚Äî Fernando
    </h2>

    <div class="text-3xl font-bold text-purple-300" id="fernandoTotal">
      ‚Äî
    </div>

    <div class="text-sm text-gray-400 mt-2 flex flex-col gap-1">
      <span id="fernandoPct">‚Äî % do total</span>
      <span class="text-xs text-gray-500">
        Total de mensagens enviadas para DM/Grupos que incluem Cec√≠lia.
      </span>
    </div>

    <div id="fernandoTags" class="flex flex-wrap gap-1 mt-4 text-xs"></div>
  </div>



  <!-- ============================ -->
  <!--   CARD ‚Äî MONITORAMENTO CEC√çLIA -->
  <!-- ============================ -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <h2 class="text-gray-400 text-sm mb-3">
      Monitoramento ‚Äî Maria Cec√≠lia
    </h2>

    <div class="text-3xl font-bold text-purple-300" id="ceciliaTotal">
      ‚Äî
    </div>

    <div class="text-sm text-gray-400 mt-2 flex flex-col gap-1">
      <span id="ceciliaPct">‚Äî % do total</span>
      <span class="text-xs text-gray-500">
        Total de mensagens enviadas pela Cec√≠lia.
      </span>
    </div>

    <div id="ceciliaTags" class="flex flex-wrap gap-1 mt-4 text-xs"></div>
  </div>



  <!-- =============================== -->
  <!--   CARD ‚Äî MAIOR OFENSOR INDIVIDUAL -->
  <!-- =============================== -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <h2 class="text-red-400 text-sm mb-3 font-semibold">
      Maior Ofensor Individual
    </h2>

    <div id="majorOffenderName" class="text-xl font-bold text-red-300">
      ‚Äî
    </div>

    <div id="majorOffenderScore" class="text-3xl font-bold text-red-500 mt-2">
      ‚Äî
    </div>

    <p id="majorOffenderPct" class="text-sm text-gray-400 mt-2">‚Äî % do total</p>

    <div id="majorOffenderTags" class="flex flex-wrap gap-1 mt-3 text-xs"></div>
  </div>


</div> <!-- fim da grid linha 1 -->



<!-- ================================================ -->
<!--  LINHA 2 ‚Äî GRUPOS OFENSORES E APOIADORES         -->
<!-- ================================================ -->

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">


  <!-- ============================= -->
  <!--   CARD ‚Äî GRUPO COM MAIS OFENSAS -->
  <!-- ============================= -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <h2 class="text-red-400 text-sm mb-3 font-semibold">
      Grupo com mais Ofensas
    </h2>

    <div id="worstGroupName" class="text-xl font-bold text-red-300">
      ‚Äî
    </div>

    <div id="worstGroupScore" class="text-3xl font-bold text-red-500 mt-2">
      ‚Äî
    </div>

    <p id="worstGroupPct" class="text-sm text-gray-400 mt-2">‚Äî % do total</p>

    <div id="worstGroupTags" class="flex flex-wrap gap-1 mt-3 text-xs"></div>
  </div>



  <!-- ============================ -->
  <!--   CARD ‚Äî MAIOR APOIADOR        -->
  <!-- ============================ -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <h2 class="text-blue-400 text-sm mb-3 font-semibold">
      Maior Apoiador
    </h2>

    <!-- 1¬∫ lugar -->
    <div id="bestSupporter1" class="mb-6">
      <div class="text-xl font-bold text-blue-300">‚Äî</div>
      <div class="text-3xl font-bold text-blue-500 mt-1">‚Äî</div>
      <p class="text-sm text-gray-400 mt-1" id="bestSupporter1Pct">‚Äî %</p>
      <div id="bestSupporter1Tags" class="flex flex-wrap gap-1 mt-2 text-xs"></div>
    </div>

    <!-- Gabriela (fixa, aparece sempre) -->
    <div id="bestSupporterGabriela" class="border-t border-gray-800 pt-4">
      <div class="text-lg font-bold text-blue-300">Mam√£e Gabriela</div>
      <div id="gabrielaSupportScore" class="text-2xl font-bold text-blue-500 mt-1">‚Äî</div>
      <p id="gabrielaSupportPct" class="text-sm text-gray-400 mt-1">‚Äî %</p>
      <div id="gabrielaSupportTags" class="flex flex-wrap gap-1 mt-2 text-xs"></div>
    </div>
  </div>



  <!-- =============================== -->
  <!--   CARD ‚Äî GRUPO COM MAIS APOIO     -->
  <!-- =============================== -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <h2 class="text-green-400 text-sm mb-3 font-semibold">
      Grupo com mais Apoio
    </h2>

    <!-- 1¬∫ lugar -->
    <div id="bestSupportGroup1" class="mb-6">
      <div class="text-xl font-bold text-green-300">‚Äî</div>
      <div class="text-3xl font-bold text-green-500 mt-1">‚Äî</div>
      <p id="bestSupportGroup1Pct" class="text-sm text-gray-400 mt-1">‚Äî %</p>
      <div id="bestSupportGroup1Tags" class="flex flex-wrap gap-1 mt-2 text-xs"></div>
    </div>

    <!-- My Family (fixo) -->
    <div id="bestSupportGroupFamily" class="border-t border-gray-800 pt-4">
      <div class="text-lg font-bold text-green-300">My Family</div>
      <div id="familySupportScore" class="text-2xl font-bold text-green-500 mt-1">‚Äî</div>
      <p id="familySupportPct" class="text-sm text-gray-400 mt-1">‚Äî %</p>
      <div id="familySupportTags" class="flex flex-wrap gap-1 mt-2 text-xs"></div>
    </div>
  </div>

</div> <!-- fim da grid linha 2 -->
<!-- ================================================ -->
<!--  LINHA 3 ‚Äî TOP GRUPOS / DMs / MENSAGEIROS        -->
<!-- ================================================ -->

<div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-12">

  <!-- TOP GRUPOS MAIS ATIVOS -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-gray-300 text-sm font-semibold">
        Top grupos mais ativos
      </h2>
      <span class="text-[11px] text-gray-500">
        Ordenados por volume de mensagens
      </span>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-xs text-left">
        <thead class="border-b border-gray-800 text-gray-400">
          <tr>
            <th class="py-1 pr-2">Grupo</th>
            <th class="py-1 pr-2 text-right">Qtd.</th>
            <th class="py-1 text-right">% do total</th>
          </tr>
        </thead>
        <tbody id="topGroupsBody" class="text-gray-200">
          <!-- preenchido via JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- TOP DMs MAIS ATIVAS -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-gray-300 text-sm font-semibold">
        Top DMs mais ativas
      </h2>
      <span class="text-[11px] text-gray-500">
        Conversas diretas (1:1)
      </span>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-xs text-left">
        <thead class="border-b border-gray-800 text-gray-400">
          <tr>
            <th class="py-1 pr-2">DM</th>
            <th class="py-1 pr-2 text-right">Qtd.</th>
            <th class="py-1 text-right">% do total</th>
          </tr>
        </thead>
        <tbody id="topDMsBody" class="text-gray-200">
          <!-- preenchido via JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 5+ MENSAGEIROS DE ALTO RISCO -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-red-400 text-sm font-semibold">
        5+ mensageiros de alto risco
      </h2>
      <span class="text-[11px] text-gray-500">
        Contatos com maior incid√™ncia de TAGs cr√≠ticas
      </span>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-xs text-left">
        <thead class="border-b border-gray-800 text-gray-400">
          <tr>
            <th class="py-1 pr-2">Contato</th>
            <th class="py-1 pr-2 text-right">Score risco</th>
            <th class="py-1 text-right">% do total</th>
          </tr>
        </thead>
        <tbody id="highRiskSendersBody" class="text-gray-200">
          <!-- preenchido via JS -->
        </tbody>
      </table>
    </div>
  </div>

</div> <!-- fim da grid linha 3 -->


<!-- ================================================ -->
<!--  LINHA 4 ‚Äî LISTAS DE MENSAGENS (BASE / CONTEXTO) -->
<!-- ================================================ -->

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-20">

  <!-- MENSAGENS COM MAIOR RISCO (IA ‚Äî BASE) -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg flex flex-col">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-red-400 text-sm font-semibold">
        Mensagens com maior risco (IA ‚Äî base)
      </h2>
      <span class="text-[11px] text-gray-500">
        Clique em uma linha para ver o contexto
      </span>
    </div>

    <!-- Filtros -->
    <div class="flex flex-wrap gap-2 mb-3 text-xs">
      <div class="flex flex-col">
        <span class="text-gray-400 mb-1">TAG</span>
        <select id="filterBaseTag" class="bg-gray-800 border border-gray-700 rounded-md px-2 py-1 text-xs">
          <option value="">Todas</option>
          <!-- preenchido via JS, sem neutro/ignorado -->
        </select>
      </div>
      <div class="flex flex-col">
        <span class="text-gray-400 mb-1">Contato</span>
        <select id="filterBaseContact" class="bg-gray-800 border border-gray-700 rounded-md px-2 py-1 text-xs">
          <option value="">Todos</option>
          <!-- preenchido via JS -->
        </select>
      </div>
      <div class="flex flex-col">
        <span class="text-gray-400 mb-1">Grupo/DM</span>
        <select id="filterBaseGroup" class="bg-gray-800 border border-gray-700 rounded-md px-2 py-1 text-xs">
          <option value="">Todos</option>
          <!-- preenchido via JS -->
        </select>
      </div>
    </div>

    <!-- Lista -->
    <div class="max-h-80 overflow-y-auto border border-gray-800 rounded-xl">
      <table class="w-full text-xs text-left">
        <thead class="bg-gray-950 sticky top-0 z-10 text-gray-400">
          <tr>
            <th class="py-1 px-2 w-24">Quando</th>
            <th class="py-1 px-2 w-40">Contato</th>
            <th class="py-1 px-2 w-40">Grupo/DM</th>
            <th class="py-1 px-2 w-20 text-right">Score</th>
            <th class="py-1 px-2">Trecho</th>
          </tr>
        </thead>
        <tbody id="baseMessagesBody" class="text-gray-200">
          <!-- preenchido via JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- MENSAGENS DE RISCO EM CONTEXTO (IA ‚Äî CONTEXTUAL) -->
  <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl shadow-lg flex flex-col">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-purple-400 text-sm font-semibold">
        Mensagens de risco em contexto (IA ‚Äî contextual)
      </h2>
      <span class="text-[11px] text-gray-500">
        Janelas de conversa ordenadas por score contextual
      </span>
    </div>

    <!-- Filtros -->
    <div class="flex flex-wrap gap-2 mb-3 text-xs">
      <div class="flex flex-col">
        <span class="text-gray-400 mb-1">TAG contextual</span>
        <select id="filterCtxTag" class="bg-gray-800 border border-gray-700 rounded-md px-2 py-1 text-xs">
          <option value="">Todas</option>
          <!-- preenchido via JS, sem neutro/ignorado -->
        </select>
      </div>
      <div class="flex flex-col">
        <span class="text-gray-400 mb-1">Contato</span>
        <select id="filterCtxContact" class="bg-gray-800 border border-gray-700 rounded-md px-2 py-1 text-xs">
          <option value="">Todos</option>
          <!-- preenchido via JS -->
        </select>
      </div>
      <div class="flex flex-col">
        <span class="text-gray-400 mb-1">Grupo/DM</span>
        <select id="filterCtxGroup" class="bg-gray-800 border border-gray-700 rounded-md px-2 py-1 text-xs">
          <option value="">Todos</option>
          <!-- preenchido via JS -->
        </select>
      </div>
    </div>

    <!-- Lista -->
    <div class="max-h-80 overflow-y-auto border border-gray-800 rounded-xl">
      <table class="w-full text-xs text-left">
        <thead class="bg-gray-950 sticky top-0 z-10 text-gray-400">
          <tr>
            <th class="py-1 px-2 w-24">Quando</th>
            <th class="py-1 px-2 w-32">Quem</th>
            <th class="py-1 px-2 w-40">Grupo/DM</th>
            <th class="py-1 px-2 w-24 text-right">Score</th>
            <th class="py-1 px-2">Contexto</th>
          </tr>
        </thead>
        <tbody id="contextMessagesBody" class="text-gray-200">
          <!-- preenchido via JS -->
        </tbody>
      </table>
    </div>
  </div>

</div> <!-- fim da grid linha 4 -->

</div> <!-- fim do container px-6 pb-20 -->



<!-- ================================================ -->
<!--  MODAL DE DETALHE DA MENSAGEM EM CONTEXTO        -->
<!-- ================================================ -->
<div
  id="messageModal"
  class="fixed inset-0 bg-black/70 hidden items-center justify-center z-40"
>
  <div
    class="bg-gray-900 rounded-xl border border-gray-700 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto p-6 relative"
  >
    <button
      onclick="closeMessageModal()"
      class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 text-xl"
      aria-label="Fechar"
    >
      ‚úï
    </button>

    <p id="modalMeta" class="text-[11px] text-gray-400 mb-1">
      <!-- hor√°rio, dire√ß√£o, score -->
    </p>

    <h3 id="modalTitle" class="text-lg font-semibold text-purple-200 mb-2">
      <!-- Nome do contato / grupo -->
    </h3>

    <div id="modalLabels" class="flex flex-wrap gap-1 text-[11px] mb-4">
      <!-- pills de labels -->
    </div>

    <div class="space-y-4 text-sm">
      <div>
        <p class="text-[11px] text-gray-400 mb-1">Mensagem principal</p>
        <div
          id="modalMainMessage"
          class="bg-gray-800 rounded-lg px-3 py-2 text-gray-100 whitespace-pre-line"
        ></div>
      </div>

      <div>
        <p class="text-[11px] text-gray-400 mb-1">Contexto anterior</p>
        <div
          id="modalContextBefore"
          class="bg-gray-800 rounded-lg px-3 py-2 text-gray-200 text-xs whitespace-pre-line"
        ></div>
      </div>

      <div>
        <p class="text-[11px] text-gray-400 mb-1">
          Respostas / continua√ß√£o
        </p>
        <div
          id="modalContextAfter"
          class="bg-gray-800 rounded-lg px-3 py-2 text-gray-200 text-xs whitespace-pre-line"
        ></div>
      </div>
    </div>
  </div>
</div>



</div> <!-- fim de #dashboardContent -->


<!-- ================================================== -->
<!--  SCRIPT BASE DO DASHBOARD (INTEGRA√á√ÉO PENDENTE)    -->
<!-- ================================================== -->

	<script>
  // Caches de mensagens para o modal
  let highRiskMessagesCache = [];
  let contextMessagesCache = [];

  // Helpers de UI simples
  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function createTagPill(label) {
    const span = document.createElement("span");
    span.className =
      "px-2 py-0.5 rounded-full border border-gray-700 bg-gray-800 text-[10px] text-gray-200";
    span.textContent = label;
    return span;
  }

  function renderTagsInto(container, tags) {
    if (!container) return;
    container.innerHTML = "";
    if (!tags) return;

    if (Array.isArray(tags)) {
      tags.forEach(t => {
        if (!t) return;
        const low = String(t).toLowerCase();
        if (low === "neutro" || low === "ignorado") return;
        container.appendChild(createTagPill(t));
      });
    } else {
      Object.keys(tags).forEach(tag => {
        const low = tag.toLowerCase();
        if (low === "neutro" || low === "ignorado") return;
        const count = tags[tag];
        const pill = createTagPill(
          count ? `${tag} (${tag})` : String(tag)
        );
        container.appendChild(pill);
      });
    }
  }

  // Modal
  function openMessageModal(sourceType, index) {
    const source =
      sourceType === "base" ? highRiskMessagesCache : contextMessagesCache;
    const msg = source[index];
    if (!msg) return;

    const modal = document.getElementById("messageModal");
    if (!modal) return;

    const dirText =
      msg.direction === "sent" ? "Mensagem enviada" : "Mensagem recebida";
    const score = msg.score ?? msg.ia_risk_score ?? msg.ia_risk_score_ctx;
    const ts = msg.timestamp || msg.date || "";

    setText(
      "modalMeta",
      `${dirText} ‚Ä¢ Score: ${score != null ? score : "‚Äî"} ‚Ä¢ ${ts}`
    );
    setText("modalTitle", msg.sender_name || msg.chat_name || "‚Äî");

    renderTagsInto(
      document.getElementById("modalLabels"),
      msg.labels || msg.tags
    );

    setText("modalMainMessage", msg.main_text || msg.text || msg.preview || "");
    setText("modalContextBefore", msg.context_before || msg.before || "");
    setText("modalContextAfter", msg.context_after || msg.after || "");

    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeMessageModal() {
    const modal = document.getElementById("messageModal");
    if (!modal) return;
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  window.closeMessageModal = closeMessageModal;
  window.openMessageModal = openMessageModal;
</script>

	
<!-- ========================================================= -->
<!--   ETAPA 5/10 ‚Äî N√öCLEO DE INTEGRA√á√ÉO COM APPS SCRIPT       -->
<!--   (fetch + preprocess + status)                           -->
<!-- ========================================================= -->

<script>

const API_URL =
  "https://script.google.com/macros/s/AKfycbylJFpFSLxAaEC_sCx9d4jpGtLBW_4d62kUlZ7EehgFWtlr0Wvc5Jv-ue2e87QEWXtX/exec";

let GLOBAL_ROWS = [];   // base de mensagens (hist√≥rico cru)
let GLOBAL_READY = false;

/* ---------------------------------------------------------
   Atualiza indicador de estado da API no cabe√ßalho
--------------------------------------------------------- */
function setApiStatus(text, colorClass = "text-yellow-400") {
  const el = document.getElementById("apiStatusText");
  if (!el) return;
  el.textContent = text;
  el.className = colorClass;
}

/* ---------------------------------------------------------
   Converte valores problem√°ticos, datas, NULOS, etc.
   Aqui apenas garantimos estrutura b√°sica.
   A l√≥gica avan√ßada entra nas etapas seguintes.
--------------------------------------------------------- */
function preprocessRows(rows) {
  if (!rows || !Array.isArray(rows)) return [];

  return rows.map(r => {
    return {
      id: r.id ?? null,
      timestamp: r.timestamp ?? null,
      sender: r.sender ?? "",
      message: r.message ?? "",
      group: r.group ?? "",
      ia_risk_score: Number(r.ia_risk_score ?? 0),
      ia_risk_score_ctx: Number(r.ia_risk_score_ctx ?? 0),
      ia_labels: (r.ia_labels ?? "").toLowerCase(),
      ia_summary: r.ia_summary ?? "",
      ia_labels_ctx: (r.ia_labels_ctx ?? "").toLowerCase(),
      ia_summary_ctx: r.ia_summary_ctx ?? "",
    };
  });
}

/* ---------------------------------------------------------
   Carrega os dados do Apps Script
   (Etapa 5 n√£o renderiza nada ‚Äî apenas baixa e prepara)
--------------------------------------------------------- */
async function loadDashboardData() {
  try {
    setApiStatus("Carregando...", "text-yellow-400");

    const res = await fetch(API_URL, { method: "GET" });
    if (!res.ok) throw new Error("Falha no fetch da API");

    const data = await res.json();
    if (!data || !data.rows) throw new Error("Resposta inv√°lida");

    GLOBAL_ROWS = preprocessRows(data.rows);
    GLOBAL_READY = true;

    setApiStatus("OK (dados carregados)", "text-green-400");

    // Na pr√≥xima etapa, chamaremos:
    // renderAllCards(GLOBAL_ROWS);
    // renderAllPanels(GLOBAL_ROWS);

  } catch (err) {
    console.error(err);
    setApiStatus("Erro ao carregar", "text-red-400");
  }
}

/* ---------------------------------------------------------
   Aciona o load assim que a dashboard abrir p√≥s-login
--------------------------------------------------------- */
function reloadDashboard() {
  if (!GLOBAL_READY) {
    loadDashboardData();
  } else {
    // Apenas recarrega da API novamente
    GLOBAL_READY = false;
    loadDashboardData();
  }
}

// Se quiser que carregue automaticamente ao abrir (opcional):
// window.addEventListener("load", loadDashboardData);

</script>


</body>
</html>





	  