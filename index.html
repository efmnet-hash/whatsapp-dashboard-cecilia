<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard WhatsApp — Neon Analytics</title>

  <!-- Tailwind via CDN (ok para projeto pessoal) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js para os gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      color-scheme: dark;
    }
    body {
      background: radial-gradient(circle at top left, #111827 0, #020617 40%, #000000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    .card {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.15), rgba(15, 23, 42, 0.95));
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(18px);
    }
    .card-soft {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), rgba(15, 23, 42, 0.95));
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(14px);
    }
    .card-header {
      font-size: 0.8rem;
      letter-spacing: .16em;
      text-transform: uppercase;
    }
    .badge-pill {
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.7rem;
    }
    .tag-chip {
      border-radius: 999px;
      padding: 0.15rem 0.65rem;
      font-size: 0.7rem;
      border-width: 1px;
    }
    .table-scroll {
      max-height: 260px;
      overflow: auto;
      scrollbar-width: thin;
    }
    .table-scroll::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }
    .table-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.45);
      border-radius: 999px;
    }
  </style>
</head>
<body class="text-slate-100">
  <div class="min-h-screen px-4 py-6 md:px-8 md:py-8">
    <!-- HEADER -->
    <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight flex items-center gap-2">
          <span class="inline-flex h-7 w-7 items-center justify-center rounded-xl bg-cyan-500/15 text-cyan-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2.166 10 10 2.167 17.834 10 10 17.834 2.166 10Zm2.829 0L10 4.995 14.99 10 10 15.005 4.995 10Z"/>
            </svg>
          </span>
          Dashboard WhatsApp — Neon Analytics
        </h1>
        <p class="mt-1 text-xs md:text-sm text-slate-400 max-w-2xl">
          Monitoramento experimental de mensagens com apoio de IA para identificar indícios de risco emocional,
          bullying, violência, sexualidade inadequada e apoio positivo. Use sempre como ponto de partida para diálogo.
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <div id="apiStatusBadge" class="badge-pill bg-red-500/10 text-red-300 border border-red-500/40 flex items-center gap-1">
          <span class="h-2 w-2 rounded-full bg-red-400 animate-pulse"></span>
          <span class="font-medium text-[0.7rem] tracking-wide uppercase">API: erro de conexão</span>
        </div>
        <button id="reloadBtn"
          class="inline-flex items-center gap-2 rounded-full bg-cyan-500/10 px-3 py-1.5 text-xs font-semibold text-cyan-200 border border-cyan-400/40 hover:bg-cyan-500/20 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 4a7 7 0 0 1 11.313-1.556A.75.75 0 1 1 14.9 3.4 5.5 5.5 0 1 0 15.5 10H14a.75.75 0 0 1 0-1.5h3.25A.75.75 0 0 1 18 9.25V6a.75.75 0 0 1 1.5 0v4.25A.75.75 0 0 1 18.75 11H15.5A7 7 0 1 1 4 4Z" clip-rule="evenodd"/>
          </svg>
          Recarregar dados
        </button>
      </div>
    </header>

    <!-- ROW 1: SUMMARY CARDS -->
    <section class="grid gap-4 md:grid-cols-4 mb-6">
      <article class="card p-4 md:p-5 flex flex-col justify-between">
        <div>
          <div class="card-header text-slate-400 mb-3">Última atualização</div>
          <div id="lastUpdate" class="text-lg font-semibold text-slate-100">–</div>
        </div>
        <p id="lastMessageTime" class="mt-4 text-[0.7rem] text-slate-400">
          Última mensagem recebida: –
        </p>
      </article>

      <article class="card p-4 md:p-5 flex flex-col justify-between">
        <div>
          <div class="card-header text-slate-400 mb-3">Mensagens totais</div>
          <p id="msgToday" class="text-xs text-slate-300 mb-1">Hoje: 0 enviadas • 0 recebidas</p>
          <p id="msgMonth" class="text-xs text-slate-300 mb-1">Mês atual: 0 mensagens</p>
          <p id="msgTotal" class="text-xs text-slate-300">Total geral: 0</p>
        </div>
      </article>

      <article class="card p-4 md:p-5 flex flex-col justify-between">
        <div>
          <div class="card-header text-slate-400 mb-3">Mensageiros de alto risco</div>
          <div id="highRiskSenders" class="space-y-1 text-xs text-slate-200">
            <p class="text-slate-500 text-[0.7rem] italic">Carregando…</p>
          </div>
        </div>
      </article>

      <article class="card p-4 md:p-5 flex flex-col justify-between">
        <div class="card-header text-slate-400 mb-3">Legenda de TAGs</div>
        <div id="tagLegend" class="flex flex-wrap gap-1.5 text-[0.7rem]"></div>
      </article>
    </section>

    <!-- ROW 2: TOP LISTS -->
    <section class="grid gap-4 md:grid-cols-3 mb-6">
      <article class="card-soft p-4 md:p-5 flex flex-col">
        <div class="card-header text-slate-400 mb-3">Top 10 grupos mais ativos</div>
        <div class="table-scroll">
          <table class="w-full text-xs">
            <thead class="sticky top-0 bg-slate-900/80 backdrop-blur">
              <tr class="text-[0.7rem] text-slate-400">
                <th class="text-left py-1.5 pr-2 font-medium">Grupo</th>
                <th class="text-right py-1.5 pl-2 font-medium w-20">Mensagens</th>
              </tr>
            </thead>
            <tbody id="topGroupsBody" class="divide-y divide-slate-800/80"></tbody>
          </table>
        </div>
      </article>

      <article class="card-soft p-4 md:p-5 flex flex-col">
        <div class="card-header text-slate-400 mb-3">Top 10 DMs mais ativas</div>
        <div class="table-scroll">
          <table class="w-full text-xs">
            <thead class="sticky top-0 bg-slate-900/80 backdrop-blur">
              <tr class="text-[0.7rem] text-slate-400">
                <th class="text-left py-1.5 pr-2 font-medium">Contato</th>
                <th class="text-right py-1.5 pl-2 font-medium w-20">Mensagens</th>
              </tr>
            </thead>
            <tbody id="topDMsBody" class="divide-y divide-slate-800/80"></tbody>
          </table>
        </div>
      </article>

      <article class="card-soft p-4 md:p-5 flex flex-col">
        <div class="card-header text-slate-400 mb-3">Top 10 canais mais ativos</div>
        <div class="table-scroll">
          <table class="w-full text-xs">
            <thead class="sticky top-0 bg-slate-900/80 backdrop-blur">
              <tr class="text-[0.7rem] text-slate-400">
                <th class="text-left py-1.5 pr-2 font-medium">Canal</th>
                <th class="text-right py-1.5 pl-2 font-medium w-20">Mensagens</th>
              </tr>
            </thead>
            <tbody id="topChannelsBody" class="divide-y divide-slate-800/80"></tbody>
          </table>
        </div>
      </article>
    </section>

    <!-- ROW 3: RISK TABLES -->
    <section class="grid gap-4 md:grid-cols-2 mb-8">
      <article class="card-soft p-4 md:p-5 flex flex-col min-h-[260px]">
        <div class="flex items-center justify-between mb-3">
          <div class="card-header text-slate-400">Mensagens com maior risco (IA — Base)</div>
        </div>
        <div class="table-scroll">
          <table class="w-full text-xs">
            <thead class="sticky top-0 bg-slate-900/80 backdrop-blur">
              <tr class="text-[0.7rem] text-slate-400">
                <th class="text-left py-1 pr-2 font-medium w-24">Quando</th>
                <th class="text-left py-1 px-2 font-medium w-28">Quem</th>
                <th class="text-left py-1 px-2 font-medium w-32">Chat</th>
                <th class="text-left py-1 px-2 font-medium">Trecho / interpretação</th>
                <th class="text-right py-1 pl-2 pr-1 font-medium w-12">Risco</th>
              </tr>
            </thead>
            <tbody id="riskBaseBody" class="divide-y divide-slate-800/80"></tbody>
          </table>
        </div>
        <p class="mt-3 text-[0.65rem] text-slate-500">
          Este painel lista mensagens com sinal automático de risco pela IA. Não substitui psicólogo nem diálogo em família.
          Use apenas como ponto de partida, nunca como julgamento definitivo.
        </p>
      </article>

      <article class="card-soft p-4 md:p-5 flex flex-col min-h-[260px]">
        <div class="flex items-center justify-between mb-3">
          <div class="card-header text-slate-400">Mensagens de risco em contexto (IA — Contextual)</div>
        </div>
        <div class="table-scroll">
          <table class="w-full text-xs">
            <thead class="sticky top-0 bg-slate-900/80 backdrop-blur">
              <tr class="text-[0.7rem] text-slate-400">
                <th class="text-left py-1 pr-2 font-medium w-24">Quando</th>
                <th class="text-left py-1 px-2 font-medium w-28">Quem</th>
                <th class="text-left py-1 px-2 font-medium w-32">Chat</th>
                <th class="text-left py-1 px-2 font-medium">Trecho / interpretação (contexto)</th>
                <th class="text-right py-1 pl-2 pr-1 font-medium w-12">Risco</th>
              </tr>
            </thead>
            <tbody id="riskCtxBody" class="divide-y divide-slate-800/80"></tbody>
          </table>
        </div>
        <p class="mt-3 text-[0.65rem] text-slate-500">
          Este painel considera a conversa original (mensagens antes e depois) para reavaliar a gravidade da situação.
        </p>
      </article>
    </section>

    <!-- ROW 4: CHARTS -->
    <section class="mb-10">
      <h2 class="text-sm font-semibold text-slate-300 tracking-wide mb-3">
        Análises gráficas — IA + atividade
      </h2>
      <div class="grid gap-4 md:grid-cols-2">
        <article class="card-soft p-4 md:p-5">
          <div class="card-header text-slate-400 mb-3">Mensagens totais por dia</div>
          <canvas id="chartMessagesPerDay" height="140"></canvas>
        </article>
        <article class="card-soft p-4 md:p-5">
          <div class="card-header text-slate-400 mb-3">Riscos altos / suicida / depressivo por dia (IA Base)</div>
          <canvas id="chartRiskPerDay" height="140"></canvas>
        </article>
        <article class="card-soft p-4 md:p-5">
          <div class="card-header text-slate-400 mb-3">Monitoramento — Fernando</div>
          <canvas id="chartFernando" height="140"></canvas>
        </article>
        <article class="card-soft p-4 md:p-5">
          <div class="card-header text-slate-400 mb-3">Monitoramento — Maria Cecília</div>
          <canvas id="chartMaria" height="140"></canvas>
        </article>
        <article class="card-soft p-4 md:p-5">
          <div class="card-header text-slate-400 mb-3">Maior ofensor individual</div>
          <canvas id="chartWorstOffender" height="140"></canvas>
        </article>
        <article class="card-soft p-4 md:p-5">
          <div class="card-header text-slate-400 mb-3">Grupo com mais ofensas</div>
          <canvas id="chartWorstGroup" height="140"></canvas>
        </article>
      </div>
    </section>

    <footer class="mt-6 pt-4 border-t border-slate-800/60 text-[0.65rem] text-slate-500 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <span>
        Este painel é experimental, desenvolvido para apoio familiar e educativo. As análises de IA não substituem avaliação
        psicológica profissional.
      </span>
      <span class="text-slate-600">
        © 2025 — Dashboard WhatsApp IA · Neon Analytics
      </span>
    </footer>
  </div>

  <!-- ====================== -->
  <!--  JAVASCRIPT PRINCIPAL  -->
  <!-- ====================== -->
  <script>
    // URL do WebApp (modo JSON)
    const API_URL = "https://script.google.com/macros/s/AKfycbxuuyGOKHX1DexWLgizBrfOFAtIAHD4ugcKWV-t8tzm30nx7LraohXr8Mh8XP79NChN/exec";

    // Campos da planilha
    const COL_TIMESTAMP = "timestamp";
    const COL_SENDER = "sender";
    const COL_PHONE = "phone";
    const COL_CHAT = "group/receiver";
    const COL_MESSAGE = "message";
    const COL_STATUS = "status";
    const COL_HOST = "host";
    const COL_ORIGEM = "origem";
    const COL_SENDER_JID = "sender_jid";
    const COL_CHAT_JID = "chat_jid";
    const COL_UNIQUE_KEY = "unique_key";
    const COL_DUPLICATE = "duplicate_flag";
    const COL_IA_SCORE = "ia_risk_score";
    const COL_IA_LABELS = "ia_labels";
    const COL_IA_SUMMARY = "ia_summary";
    const COL_IA_CTX_SCORE = "ia_risk_score_ctx";
    const COL_IA_CTX_LABELS = "ia_labels_ctx";
    const COL_IA_CTX_SUMMARY = "ia_summary_ctx";
    const COL_IA_CTX_ROWIDS = "ia_ctx_rowids";

    // Tags oficiais (para legenda)
    const OFFICIAL_TAGS = [
      "neutro", "desrespeito", "apoio_positivo", "depressivo",
      "bullying", "violencia", "controle_ciumento", "sexual_inadequado",
      "suicida", "autoagressao", "isolamento", "autoimagem_negativa",
      "ansiedade", "medo", "luto", "linguagem_ofensiva", "risco_social", "outro"
    ];

    // Estado em memória
    let rawData = [];
    let messages = [];

    // Referências DOM
    const apiStatusBadge = document.getElementById("apiStatusBadge");
    const lastUpdateEl = document.getElementById("lastUpdate");
    const lastMessageTimeEl = document.getElementById("lastMessageTime");
    const msgTodayEl = document.getElementById("msgToday");
    const msgMonthEl = document.getElementById("msgMonth");
    const msgTotalEl = document.getElementById("msgTotal");
    const highRiskSendersEl = document.getElementById("highRiskSenders");
    const tagLegendEl = document.getElementById("tagLegend");
    const topGroupsBody = document.getElementById("topGroupsBody");
    const topDMsBody = document.getElementById("topDMsBody");
    const topChannelsBody = document.getElementById("topChannelsBody");
    const riskBaseBody = document.getElementById("riskBaseBody");
    const riskCtxBody = document.getElementById("riskCtxBody");

    const reloadBtn = document.getElementById("reloadBtn");

    // Charts
    let chartMessagesPerDay,
        chartRiskPerDay,
        chartFernando,
        chartMaria,
        chartWorstOffender,
        chartWorstGroup;

    // Utilidades ----------------------
    function setApiStatus(label, ok) {
      apiStatusBadge.className =
        "badge-pill flex items-center gap-1 border " +
        (ok
          ? "bg-emerald-500/10 text-emerald-300 border-emerald-500/40"
          : "bg-red-500/10 text-red-300 border-red-500/40");
      apiStatusBadge.innerHTML = `
        <span class="h-2 w-2 rounded-full ${ok ? "bg-emerald-400" : "bg-red-400"} animate-pulse"></span>
        <span class="font-medium text-[0.7rem] tracking-wide uppercase">API: ${label}</span>
      `;
    }

    function parseTimestampToDate(ts) {
      if (!ts) return null;
      if (ts instanceof Date) return ts;

      // tenta "dd/M/yyyy HH:mm:ss"
      const m = String(ts).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})[ T](\d{1,2}):(\d{2})(?::(\d{2}))?/);
      if (m) {
        const [_, d, mo, y, h, mi, s] = m;
        return new Date(
          Number(y),
          Number(mo) - 1,
          Number(d),
          Number(h),
          Number(mi),
          s ? Number(s) : 0
        );
      }
      // fallback: Date.parse
      const d = new Date(ts);
      return isNaN(d.getTime()) ? null : d;
    }

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function formatDateTimeHuman(date) {
      if (!date) return "–";
      const d = String(date.getDate()).padStart(2, "0");
      const mo = String(date.getMonth() + 1).padStart(2, "0");
      const y = date.getFullYear();
      const h = String(date.getHours()).padStart(2, "0");
      const mi = String(date.getMinutes()).padStart(2, "0");
      const s = String(date.getSeconds()).padStart(2, "0");
      return `${d}/${mo}/${y} ${h}:${mi}:${s}`;
    }

    function toNumberSafe(val, def = 0) {
      const n = Number(val);
      return isNaN(n) ? def : n;
    }

    function parseLabels(str) {
      if (!str) return [];
      if (Array.isArray(str)) return str;
      return String(str)
        .split(/[;,]/)
        .map(t => t.trim())
        .filter(Boolean);
    }

    function normalizeOrigem(val) {
      const v = String(val || "").toUpperCase();
      if (v.includes("GRUPO")) return "GRUPO";
      if (v.includes("DM") || v.includes("PRIVADO")) return "DM";
      if (v.includes("CANAL")) return "CANAL";
      return val || "";
    }

    function isDuplicateRow(row) {
      const f = (row[COL_DUPLICATE] || "").toString().toUpperCase();
      if (!f) return false;
      return f === "1" || f === "TRUE" || f === "SIM" || f.includes("DUPLIC");
    }

    function setLastUpdateNow() {
      lastUpdateEl.textContent = formatDateTimeHuman(new Date());
    }

    function setLastMessageTimeFromData() {
      if (!messages.length) {
        lastMessageTimeEl.textContent = "Última mensagem recebida: –";
        return;
      }
      const latest = messages.reduce((acc, m) => {
        if (!acc) return m;
        if (m.dateObj && m.dateObj > acc.dateObj) return m;
        return acc;
      }, null);
      lastMessageTimeEl.textContent =
        "Última mensagem recebida: " + formatDateTimeHuman(latest?.dateObj);
    }

    // Renderização de legenda de TAGs
    function renderTagLegend() {
      tagLegendEl.innerHTML = "";
      OFFICIAL_TAGS.forEach(tag => {
        const span = document.createElement("span");
        span.className =
          "tag-chip border-slate-500/50 text-slate-200 bg-slate-900/60";
        span.textContent = tag;
        tagLegendEl.appendChild(span);
      });
    }

    // ================================
    // CARREGAMENTO DA API
    // ================================
    async function fetchDataFromApi() {
      setApiStatus("carregando...", false);

      try {
        const resp = await fetch(API_URL);
        if (!resp.ok) {
          setApiStatus(`erro HTTP ${resp.status}`, false);
          console.error("Erro na resposta da API:", resp.status, await resp.text());
          return;
        }

        const json = await resp.json();
        if (!Array.isArray(json)) {
          setApiStatus("formato inválido", false);
          console.error("Resposta da API não é array:", json);
          return;
        }

        rawData = json;

        // Normalização
        messages = rawData
          .filter(row => !isDuplicateRow(row))
          .map(row => {
            const dateObj = parseTimestampToDate(row[COL_TIMESTAMP]);
            const origem = normalizeOrigem(row[COL_ORIGEM]);
            const iaBaseScore = toNumberSafe(row[COL_IA_SCORE], 0);
            const iaCtxScore = toNumberSafe(row[COL_IA_CTX_SCORE], 0);
            const iaBaseLabels = parseLabels(row[COL_IA_LABELS]);
            const iaCtxLabels = parseLabels(row[COL_IA_CTX_LABELS]);

            return {
              id: row["#"] ?? row.id ?? null,
              timestampRaw: row[COL_TIMESTAMP] ?? "",
              dateObj,
              dateKey: dateObj ? formatDateKey(dateObj) : "",
              sender: row[COL_SENDER] ?? "",
              phone: row[COL_PHONE] ?? "",
              chatName: row[COL_CHAT] ?? "",
              message: row[COL_MESSAGE] ?? "",
              status: row[COL_STATUS] ?? "",
              host: row[COL_HOST] ?? "",
              origem,
              sender_jid: row[COL_SENDER_JID] ?? "",
              chat_jid: row[COL_CHAT_JID] ?? "",
              unique_key: row[COL_UNIQUE_KEY]
                ? String(row[COL_UNIQUE_KEY])
                : "",
              ia_risk_score: iaBaseScore,
              ia_labels: iaBaseLabels,
              ia_summary: row[COL_IA_SUMMARY] ?? "",
              ia_risk_score_ctx: iaCtxScore,
              ia_labels_ctx: iaCtxLabels,
              ia_summary_ctx: row[COL_IA_CTX_SUMMARY] ?? "",
              ia_ctx_rowids: row[COL_IA_CTX_ROWIDS] ?? ""
            };
          })
          .filter(m => m.dateObj);

        setApiStatus("ok", true);
        setLastUpdateNow();
        setLastMessageTimeFromData();

        updateSummaryCards();
        renderTopLists();
        renderRiskPanels();
        renderAllCharts();

        console.log(
          "Dados carregados e normalizados. Total de mensagens:",
          messages.length
        );
      } catch (err) {
        console.error("Erro ao carregar dados da API:", err);
        setApiStatus("erro de conexão", false);
      }
    }

    // =========================
    // RESUMO (cards superiores)
    // =========================
    function updateSummaryCards() {
      const total = messages.length;
      msgTotalEl.textContent = `Total geral: ${total.toLocaleString("pt-BR")}`;

      const now = new Date();
      const todayKey = formatDateKey(now);
      const month = now.getMonth();
      const year = now.getFullYear();

      let todaySent = 0;
      let todayReceived = 0;
      let monthCount = 0;

      messages.forEach(m => {
        if (!m.dateObj) return;
        const dKey = m.dateKey;
        if (dKey === todayKey) {
          if (String(m.status || "").toLowerCase().includes("enviado")) {
            todaySent++;
          } else {
            todayReceived++;
          }
        }
        if (
          m.dateObj.getFullYear() === year &&
          m.dateObj.getMonth() === month
        ) {
          monthCount++;
        }
      });

      msgTodayEl.textContent = `Hoje: ${todaySent} enviadas • ${todayReceived} recebidas`;
      msgMonthEl.textContent = `Mês atual: ${monthCount} mensagens`;

      // Mensageiros de alto risco (top 5 por soma de scores base + contextual)
      const riskBySender = new Map();
      messages.forEach(m => {
        const score = (m.ia_risk_score || 0) + (m.ia_risk_score_ctx || 0);
        if (score <= 0) return;
        const key = m.sender || m.phone || "Desconhecido";
        const cur = riskBySender.get(key) || { score: 0, labels: {} };
        cur.score += score;
        [...m.ia_labels, ...m.ia_labels_ctx].forEach(lbl => {
          const l = lbl.toLowerCase();
          if (!l || l === "ignorado") return;
          cur.labels[l] = (cur.labels[l] || 0) + 1;
        });
        riskBySender.set(key, cur);
      });

      const topRisk = Array.from(riskBySender.entries())
        .sort((a, b) => b[1].score - a[1].score)
        .slice(0, 5);

      if (!topRisk.length) {
        highRiskSendersEl.innerHTML =
          '<p class="text-[0.7rem] text-slate-500 italic">Nenhum remetente de alto risco identificado até agora.</p>';
      } else {
        highRiskSendersEl.innerHTML = "";
        topRisk.forEach(([name, info], idx) => {
          const row = document.createElement("div");
          row.className = "flex flex-col gap-0.5";
          const labelParts = Object.entries(info.labels)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 4)
            .map(([lbl, cnt]) => `${lbl} (${cnt})`);
          row.innerHTML = `
            <div class="flex items-center justify-between">
              <span class="text-xs font-medium text-slate-100">${idx + 1}. ${name}</span>
              <span class="text-[0.65rem] text-slate-400">score: ${Math.round(
                info.score
              )}</span>
            </div>
            <div class="text-[0.65rem] text-slate-400">
              ${labelParts.join(" • ") || "–"}
            </div>
          `;
          highRiskSendersEl.appendChild(row);
        });
      }
    }

    // =====================
    // LISTAS TOP (grids)
    // =====================
    function groupCount(filterFn, keyFn) {
      const map = new Map();
      messages.filter(filterFn).forEach(m => {
        const key = keyFn(m);
        if (!key) return;
        map.set(key, (map.get(key) || 0) + 1);
      });
      return Array.from(map.entries()).sort((a, b) => b[1] - a[1]);
    }

    function renderTopLists() {
      // grupos
      const topGroups = groupCount(
        m => m.origem === "GRUPO",
        m => m.chatName
      ).slice(0, 10);

      topGroupsBody.innerHTML = "";
      topGroups.forEach(([name, count]) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-800/60";
        tr.innerHTML = `
          <td class="py-1.5 pr-2">${name || "—"}</td>
          <td class="py-1.5 pl-2 text-right text-slate-300">${count}</td>
        `;
        topGroupsBody.appendChild(tr);
      });

      // DMs
      const topDMs = groupCount(
        m => m.origem === "DM",
        m => m.sender
      ).slice(0, 10);
      topDMsBody.innerHTML = "";
      topDMs.forEach(([name, count]) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-800/60";
        tr.innerHTML = `
          <td class="py-1.5 pr-2">${name || "—"}</td>
          <td class="py-1.5 pl-2 text-right text-slate-300">${count}</td>
        `;
        topDMsBody.appendChild(tr);
      });

      // Canais
      const topChannels = groupCount(
        m => m.origem === "CANAL",
        m => m.chatName
      ).slice(0, 10);
      topChannelsBody.innerHTML = "";
      topChannels.forEach(([name, count]) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-800/60";
        tr.innerHTML = `
          <td class="py-1.5 pr-2">${name || "—"}</td>
          <td class="py-1.5 pl-2 text-right text-slate-300">${count}</td>
        `;
        topChannelsBody.appendChild(tr);
      });
    }

    // =====================
    // PAINÉIS DE RISCO
    // =====================
    function renderRiskPanels() {
      const BASE_THRESHOLD = 50;
      const CTX_THRESHOLD = 50;

      // base
      const baseMsgs = messages
        .filter(m => (m.ia_risk_score || 0) >= BASE_THRESHOLD)
        .sort((a, b) => b.ia_risk_score - a.ia_risk_score)
        .slice(0, 20);

      riskBaseBody.innerHTML = "";
      baseMsgs.forEach(m => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-800/60";
        tr.innerHTML = `
          <td class="py-1.5 pr-2 align-top text-slate-300">${formatDateTimeHuman(
            m.dateObj
          )}</td>
          <td class="py-1.5 px-2 align-top text-slate-200">${m.sender ||
            "—"}</td>
          <td class="py-1.5 px-2 align-top text-slate-300">${m.chatName ||
            "—"}</td>
          <td class="py-1.5 px-2 align-top text-slate-200">
            <div class="text-slate-100 mb-1">${m.message || "—"}</div>
            <div class="text-[0.65rem] text-slate-400">${m.ia_summary ||
              ""}</div>
          </td>
          <td class="py-1.5 pl-2 pr-1 align-top text-right text-amber-300 font-semibold">${Math.round(
            m.ia_risk_score
          )}</td>
        `;
        riskBaseBody.appendChild(tr);
      });

      // contextual
      const ctxMsgs = messages
        .filter(m => (m.ia_risk_score_ctx || 0) >= CTX_THRESHOLD)
        .sort((a, b) => b.ia_risk_score_ctx - a.ia_risk_score_ctx)
        .slice(0, 20);

      riskCtxBody.innerHTML = "";
      ctxMsgs.forEach(m => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-800/60";
        tr.innerHTML = `
          <td class="py-1.5 pr-2 align-top text-slate-300">${formatDateTimeHuman(
            m.dateObj
          )}</td>
          <td class="py-1.5 px-2 align-top text-slate-200">${m.sender ||
            "—"}</td>
          <td class="py-1.5 px-2 align-top text-slate-300">${m.chatName ||
            "—"}</td>
          <td class="py-1.5 px-2 align-top text-slate-200">
            <div class="text-slate-100 mb-1">${m.message || "—"}</div>
            <div class="text-[0.65rem] text-slate-400">${m.ia_summary_ctx ||
              ""}</div>
          </td>
          <td class="py-1.5 pl-2 pr-1 align-top text-right text-amber-300 font-semibold">${Math.round(
            m.ia_risk_score_ctx
          )}</td>
        `;
        riskCtxBody.appendChild(tr);
      });
    }

    // =====================
    // GRÁFICOS (Chart.js)
    // =====================
    function buildLineChart(ctx, label, labels, data, color) {
      return new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label,
              data,
              tension: 0.35,
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              borderColor: color
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: "index",
              intersect: false
            }
          },
          scales: {
            x: {
              ticks: { color: "#9ca3af", maxRotation: 0 },
              grid: { display: false }
            },
            y: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(55,65,81,0.5)" }
            }
          }
        }
      });
    }

    function renderAllCharts() {
      const byDay = new Map();
      const riskByDay = new Map();

      messages.forEach(m => {
        const key = m.dateKey;
        if (!key) return;
        byDay.set(key, (byDay.get(key) || 0) + 1);

        const score =
          (m.ia_risk_score || 0) +
          (m.ia_risk_score_ctx || 0);
        if (score > 0) {
          riskByDay.set(key, (riskByDay.get(key) || 0) + score);
        }
      });

      const dayLabels = Array.from(byDay.keys()).sort();
      const msgsData = dayLabels.map(d => byDay.get(d) || 0);
      const riskData = dayLabels.map(d => riskByDay.get(d) || 0);

      const ctx1 = document
        .getElementById("chartMessagesPerDay")
        .getContext("2d");
      const ctx2 = document
        .getElementById("chartRiskPerDay")
        .getContext("2d");

      if (chartMessagesPerDay) chartMessagesPerDay.destroy();
      if (chartRiskPerDay) chartRiskPerDay.destroy();

      chartMessagesPerDay = buildLineChart(
        ctx1,
        "Mensagens por dia",
        dayLabels,
        msgsData,
        "#38bdf8"
      );
      chartRiskPerDay = buildLineChart(
        ctx2,
        "Soma dos scores de risco por dia",
        dayLabels,
        riskData,
        "#f97316"
      );

      // Monitoramento Fernando / Maria / ofensor / grupo com mais ofensas:
      // aqui para não alongar demais, vamos aproveitar os mesmos dados de risco,
      // focando em subsets simples.

      const fernandoId = "558195977127";
      const mariaId = "Maria Cecília";

      function buildPersonSeries(predicate) {
        const map = new Map();
        messages
          .filter(predicate)
          .forEach(m => {
            const k = m.dateKey;
            if (!k) return;
            const score =
              (m.ia_risk_score || 0) +
              (m.ia_risk_score_ctx || 0);
            if (score <= 0) return;
            map.set(k, (map.get(k) || 0) + score);
          });
        const labels = Array.from(map.keys()).sort();
        const data = labels.map(d => map.get(d) || 0);
        return { labels, data };
      }

      const fern = buildPersonSeries(
        m =>
          (m.phone || "").includes(fernandoId) ||
          (m.sender || "").includes("Fernando")
      );
      const maria = buildPersonSeries(
        m =>
          (m.sender || "").includes(mariaId) ||
          (m.chatName || "").includes(mariaId)
      );

      const ctxF = document.getElementById("chartFernando").getContext("2d");
      const ctxM = document.getElementById("chartMaria").getContext("2d");

      if (chartFernando) chartFernando.destroy();
      if (chartMaria) chartMaria.destroy();

      chartFernando = buildLineChart(
        ctxF,
        "Risco diário — Fernando",
        fern.labels,
        fern.data,
        "#a855f7"
      );
      chartMaria = buildLineChart(
        ctxM,
        "Risco diário — Maria Cecília",
        maria.labels,
        maria.data,
        "#22c55e"
      );

      // Maior ofensor individual e grupo com mais ofensas
      const offenseTags = new Set([
        "desrespeito",
        "bullying",
        "violencia",
        "linguagem_ofensiva",
        "controle_ciumento"
      ]);

      const offenderMap = new Map();
      const groupOffenseMap = new Map();

      messages.forEach(m => {
        const labels = [
          ...m.ia_labels,
          ...m.ia_labels_ctx
        ].map(l => l.toLowerCase());
        if (!labels.some(l => offenseTags.has(l))) return;

        const score =
          (m.ia_risk_score || 0) +
          (m.ia_risk_score_ctx || 0);

        const senderKey = m.sender || m.phone || "Desconhecido";
        offenderMap.set(
          senderKey,
          (offenderMap.get(senderKey) || 0) + score
        );

        if (m.origem === "GRUPO") {
          const gKey = m.chatName || "Grupo";
          groupOffenseMap.set(
            gKey,
            (groupOffenseMap.get(gKey) || 0) + score
          );
        }
      });

      const worstOffender = Array.from(offenderMap.entries()).sort(
        (a, b) => b[1] - a[1]
      )[0];
      const worstGroup = Array.from(groupOffenseMap.entries()).sort(
        (a, b) => b[1] - a[1]
      )[0];

      function buildSingleSeries(entryMap, key) {
        const map = new Map();
        messages.forEach(m => {
          const labels = [
            ...m.ia_labels,
            ...m.ia_labels_ctx
          ].map(l => l.toLowerCase());
          if (!labels.some(l => offenseTags.has(l))) return;
          if (!key(m)) return;
          const k = m.dateKey;
          if (!k) return;
          const s =
            (m.ia_risk_score || 0) +
            (m.ia_risk_score_ctx || 0);
          map.set(k, (map.get(k) || 0) + s);
        });
        const labels = Array.from(map.keys()).sort();
        const data = labels.map(d => map.get(d) || 0);
        return { labels, data };
      }

      const ctxWO = document
        .getElementById("chartWorstOffender")
        .getContext("2d");
      const ctxWG = document
        .getElementById("chartWorstGroup")
        .getContext("2d");

      if (chartWorstOffender) chartWorstOffender.destroy();
      if (chartWorstGroup) chartWorstGroup.destroy();

      if (worstOffender) {
        const series = buildSingleSeries(
          offenderMap,
          m => (m.sender || m.phone || "Desconhecido") === worstOffender[0]
        );
        chartWorstOffender = buildLineChart(
          ctxWO,
          `Ofensor: ${worstOffender[0]}`,
          series.labels,
          series.data,
          "#f97316"
        );
      }

      if (worstGroup) {
        const series = buildSingleSeries(
          groupOffenseMap,
          m => (m.chatName || "Grupo") === worstGroup[0]
        );
        chartWorstGroup = buildLineChart(
          ctxWG,
          `Grupo: ${worstGroup[0]}`,
          series.labels,
          series.data,
          "#eab308"
        );
      }
    }

    // =====================
    // INICIALIZAÇÃO
    // =====================
    function init() {
      renderTagLegend();
      fetchDataFromApi();
    }

    reloadBtn.addEventListener("click", () => {
      fetchDataFromApi();
    });

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
