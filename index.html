<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard WhatsApp – Cecília (versão iA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }
    .subtitle {
      color: #9ca3af;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .card {
      background: #020617;
      border-radius: 10px;
      padding: 12px 14px;
      border: 1px solid #1f2937;
    }
    .card-title {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .card-value {
      font-size: 1.4rem;
      font-weight: 600;
    }
    .card-extra {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 4px;
    }
    .columns {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
    }
    .panel {
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 12px 14px;
      margin-bottom: 16px;
    }
    .panel-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #1f2937;
      vertical-align: top;
    }
    th {
      text-align: left;
      color: #9ca3af;
      font-weight: 500;
    }
    tr:nth-child(even) {
      background: #020617;
    }

    /* TAGs com código de cor unificado */
    .tag {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #374151;
      margin-right: 4px;
      margin-bottom: 2px;
      white-space: nowrap;
    }
    .tag-risk {
      border-color: #b91c1c;
      color: #fecaca;
    }
    .tag-medium {
      border-color: #d97706;
      color: #fed7aa;
    }
    .tag-low {
      border-color: #15803d;
      color: #bbf7d0;
    }

    .footer {
      margin-top: 12px;
      font-size: 0.75rem;
      color: #6b7280;
    }
    .danger {
      color: #fecaca;
    }

    /* Contêiner rolável para as mensagens de risco */
    .risk-table-container {
      max-height: 340px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #1f2937;
    }
    .risk-table-container table {
      margin: 0;
    }

    /* Texto clicável da mensagem abre popup */
    .message-preview {
      cursor: pointer;
    }
    .message-preview:hover {
      text-decoration: underline;
    }

    /* Modal para mensagem completa */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal.hidden {
      display: none;
    }
    .modal-content {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      max-width: 640px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid #1f2937;
      font-size: 0.9rem;
    }
    .modal-body {
      padding: 10px 14px;
      overflow-y: auto;
    }
    .modal-close-btn {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .modal-close-btn:hover {
      color: #e5e7eb;
    }
    .modal-message {
      white-space: pre-wrap;
      font-family: inherit;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    /* Gráficos */
    .chart-panel {
      margin-top: 8px;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 220px;
    }

    @media (max-width: 900px) {
      .columns {
        grid-template-columns: minmax(0, 1fr);
      }
      .modal-content {
        margin: 0 8px;
      }
    }
  </style>
</head>
<body>
  <h1>Dashboard WhatsApp – Monitoramento Cecília (versão iA)</h1>
  <div class="subtitle">
    Painel privado para acompanhar volume de mensagens e sinais de risco em grupos de adolescentes.
  </div>

  <div class="cards">
    <!-- 1) Última atualização -->
    <div class="card">
      <div class="card-title">Última atualização</div>
      <div class="card-value" id="lastUpdate">–</div>
      <div class="card-extra">
        <span id="dateRange">Mensagens entre – e –</span><br />
        IA aplicada sobre o histórico<br />
        Atualiza a cada 60s
      </div>
    </div>

    <!-- 2) Mensagens totais -->
    <div class="card">
      <div class="card-title">Mensagens totais</div>
      <div class="card-value" id="totalMessages">–</div>
      <div class="card-extra">
        Este mês:<br />
        <strong id="monthSent">–</strong> enviadas<br />
        <strong id="monthReceived">–</strong> recebidas<br /><br />
        Hoje:<br />
        <strong id="todaySent">–</strong> enviadas<br />
        <strong id="todayReceived">–</strong> recebidas<br /><br />
        Contatos únicos: <strong id="uniqueSenders">–</strong><br />
        Grupos/DM únicos: <strong id="uniqueGroups">–</strong>
      </div>
    </div>

    <!-- 3) Riscos altos -->
    <div class="card">
      <div class="card-title">Riscos altos / suicidas &amp; depressivos</div>
      <div class="card-value" id="highRiskCount">–</div>
      <div class="card-extra">
        <div id="highRiskTagsSummary">
          <!-- TAGs suicida/depressivo/violencia/autoagressao entram aqui -->
        </div>
      </div>
    </div>

    <!-- 4) 5+ Mensageiros de alto risco -->
    <div class="card">
      <div class="card-title">5+ Mensageiros de alto risco</div>
      <div class="card-value">Top 5</div>
      <div class="card-extra" id="highRiskContacts">
        –
      </div>
    </div>

    <!-- 5) Fernando -->
    <div class="card">
      <div class="card-title">Monitoramento – Fernando</div>
      <div class="card-value" id="fernandoRiskCount">–</div>
      <div class="card-extra">
        Mensagens de Fernando: <strong id="fernandoTotal">–</strong><br />
        Com apoio positivo: <strong id="fernandoPositiveCount">–</strong><br />
        Principais TAGs:
        <span id="fernandoTagsSummary">–</span>
      </div>
    </div>

    <!-- 6) Maria Cecília -->
    <div class="card">
      <div class="card-title">Monitoramento – Maria Cecília</div>
      <div class="card-value" id="mariaRiskCount">–</div>
      <div class="card-extra">
        Mensagens de Maria Cecília: <strong id="mariaTotal">–</strong><br />
        Com apoio positivo: <strong id="mariaPositiveCount">–</strong><br />
        Principais TAGs:
        <span id="mariaTagsSummary">–</span>
      </div>
    </div>

    <!-- 7) Maior ofensor individual -->
    <div class="card">
      <div class="card-title">Maior ofensor individual</div>
      <div class="card-value" id="topOffenderName">–</div>
      <div class="card-extra">
        Mensagens de risco: <strong id="topOffenderRiskCount">–</strong><br />
        TAGs principais: <span id="topOffenderTags">–</span>
      </div>
    </div>

    <!-- 8) Grupo com mais ofensas -->
    <div class="card">
      <div class="card-title">Grupo com mais ofensas</div>
      <div class="card-value" id="topOffenderGroupName">–</div>
      <div class="card-extra">
        Mensagens de risco: <strong id="topOffenderGroupRiskCount">–</strong><br />
        TAGs principais: <span id="topOffenderGroupTags">–</span>
      </div>
    </div>

    <!-- 9) Maior apoiador -->
    <div class="card">
      <div class="card-title">Maior apoiador (positivo)</div>
      <div class="card-value" id="topSupporterName">–</div>
      <div class="card-extra">
        Mensagens de apoio: <strong id="topSupporterPositiveCount">–</strong><br />
        TAGs principais: <span id="topSupporterTags">–</span>
      </div>
    </div>

    <!-- 10) Grupo com mais apoio positivo -->
    <div class="card">
      <div class="card-title">Grupo com mais apoio positivo</div>
      <div class="card-value" id="topSupporterGroupName">–</div>
      <div class="card-extra">
        Mensagens de apoio: <strong id="topSupporterGroupPositiveCount">–</strong><br />
        TAGs principais: <span id="topSupporterGroupTags">–</span>
      </div>
    </div>

    <!-- 11) 2º Grupo com mais apoio positivo (prioriza My Family) -->
    <div class="card">
      <div class="card-title">2º Grupo com mais apoio positivo</div>
      <div class="card-value" id="secondSupporterGroupName">–</div>
      <div class="card-extra">
        Mensagens de apoio: <strong id="secondSupporterGroupPositiveCount">–</strong><br />
        TAGs principais: <span id="secondSupporterGroupTags">–</span>
      </div>
    </div>
  </div>

  <div class="columns">
    <div>
      <div class="panel">
        <div class="panel-title">Top remetentes (por quantidade de mensagens)</div>
        <table id="topSendersTable">
          <thead>
            <tr>
              <th>Remetente</th>
              <th>Qtd.</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="panel">
        <div class="panel-title">Top grupos mais ativos</div>
        <table id="topGroupsTable">
          <thead>
            <tr>
              <th>Grupo</th>
              <th>Qtd.</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="panel">
        <div class="panel-title">Top DMs mais ativas</div>
        <table id="topDMsTable">
          <thead>
            <tr>
              <th>DM</th>
              <th>Qtd.</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="panel">
        <div class="panel-title">Mensagens com maior risco (IA)</div>

        <!-- Filtros TAG + contato + grupo na mesma linha -->
        <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <span class="card-extra">TAG:</span>
          <select id="riskTagFilter">
            <option value="">Todas</option>
          </select>

          <span class="card-extra">Contato:</span>
          <select id="riskContactFilter">
            <option value="">Todos</option>
          </select>

          <span class="card-extra">Grupo/DM:</span>
          <select id="riskGroupFilter">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="risk-table-container">
          <table id="riskMessagesTable">
            <thead>
              <tr>
                <th>Quando</th>
                <th>Quem</th>
                <th>Grupo / DM</th>
                <th>Trecho / avaliação</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card-extra danger" style="margin-top:6px;">
          ⚠️ Este painel é apenas um filtro automático com base em IA.
          Não substitui psicólogo, nem diálogo em família. Use como ponto de partida,
          nunca como julgamento definitivo.
        </div>
      </div>

      <!-- Painel de mensagens em contexto -->
      <div class="panel">
        <div class="panel-title">Mensagens de risco em contexto (IA)</div>
        <div class="card-extra" style="margin-bottom:6px;">
          Painel alimentado por IA_Classifier_Contextual. Mostra a avaliação contextual e um resumo da janela de conversa até 3 antes e 2 depois.
        </div>

        <!-- Filtros TAG + contato + grupo -->
        <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <span class="card-extra">TAG:</span>
          <select id="ctxTagFilter">
            <option value="">Todas</option>
          </select>

          <span class="card-extra">Contato:</span>
          <select id="ctxContactFilter">
            <option value="">Todos</option>
          </select>

          <span class="card-extra">Grupo/DM:</span>
          <select id="ctxGroupFilter">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="risk-table-container" style="max-height:260px;">
          <table id="contextMessagesTable">
            <thead>
              <tr>
                <th>Quando</th>
                <th>Quem</th>
                <th>Grupo / DM</th>
                <th>Contexto</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Painel de distribuição de mensagens por TAG (IA) -->
  <div class="panel">
    <div class="panel-title">Distribuição de mensagens por TAG (IA)</div>
    <table id="tagDistributionTable">
      <thead>
        <tr>
          <th>TAG</th>
          <th>Qtd.</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="card-extra" style="margin-top:6px;">
      Cada TAG representa uma classificação feita pela IA nas mensagens analisadas
      (depressivo, bullying, apoio_positivo, etc.).
    </div>
  </div>

  <!-- ================== NOVA SEÇÃO DE GRÁFICOS ================== -->
  <div class="panel chart-panel">
    <div class="panel-title">Mensagens totais por dia</div>
    <div class="chart-container">
      <canvas id="chartTotalMessages"></canvas>
    </div>
  </div>

  <div class="panel chart-panel">
    <div class="panel-title">Riscos altos / suicidas & depressivos por dia</div>
    <div class="chart-container">
      <canvas id="chartHighRiskTags"></canvas>
    </div>
  </div>

  <div class="panel chart-panel">
    <div class="panel-title">Monitoramento – Fernando (mensagens de risco por dia)</div>
    <div class="chart-container">
      <canvas id="chartFernando"></canvas>
    </div>
  </div>

  <div class="panel chart-panel">
    <div class="panel-title">Monitoramento – Maria Cecília (mensagens de risco por dia)</div>
    <div class="chart-container">
      <canvas id="chartMaria"></canvas>
    </div>
  </div>

  <div class="panel chart-panel">
    <div class="panel-title">Maior ofensor individual – mensagens de risco por dia</div>
    <div class="chart-container">
      <canvas id="chartTopOffender"></canvas>
    </div>
  </div>

  <div class="panel chart-panel">
    <div class="panel-title">Grupo com mais ofensas – mensagens de risco por dia</div>
    <div class="chart-container">
      <canvas id="chartTopOffenderGroup"></canvas>
    </div>
  </div>

  <div class="panel chart-panel">
    <div class="panel-title">Mensagens com maior risco (IA) – soma diária dos scores por TAG</div>
    <div class="chart-container">
      <canvas id="chartRiskScores"></canvas>
    </div>
  </div>

  <div class="panel chart-panel">
    <div class="panel-title">Mensagens de risco em contexto (IA) – soma diária dos scores por TAG</div>
    <div class="chart-container">
      <canvas id="chartCtxScores"></canvas>
    </div>
  </div>
  <!-- ================== FIM DA SEÇÃO DE GRÁFICOS ================== -->

  <div class="footer">
    Construído para uso privado e educativo. Não substitui acompanhamento profissional,
    nem deve ser usado para rotular pessoas. O objetivo é ajudar responsáveis a acompanhar
    a qualidade das interações e abrir conversas quando necessário.
  </div>

  <!-- Modal para exibir mensagem completa / contexto -->
  <div id="messageModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <span id="modalTitle">Mensagem completa</span>
        <button id="modalCloseBtn" class="modal-close-btn" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modalMeta" class="card-extra"></div>
        <div id="modalTags"></div>
        <div id="modalSummary" class="card-extra" style="margin-top:6px;"></div>
        <div class="modal-message" id="modalMessageText"></div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // URL DO SEU WEB APP DO APPS SCRIPT
    const API_URL = "https://script.google.com/macros/s/AKfycbxxWBB-Jfjkp6NvFnucY9XF88Y4mf-4cWy5aVt8SMNaugOsYdqmVYVh5Bdl_uNC2yGA/exec?mode=json";

    // Mapa de nomes "de -> para"
    const NAME_MAP = {
      "120363402480279175@g.us": "Revolução dos bichos",
      "120363220644765994@g.us": "Trabalho de pesquisa",
      "558182121128@s.whatsapp.net": "Mamãe Gabriela",
      // adicione mais mapeamentos aqui...
    };
    function mapName(raw) {
      if (!raw) return "";
      return NAME_MAP[raw] || raw;
    }

    // Forçar alguns chats específicos a serem tratados como GRUPO
    const FORCE_GROUP = new Set([
      "120363402480279175@g.us", // Revolução dos bichos (ID)
      "Revolução dos bichos",    // nome do grupo
      "Grupo do Bar",
      "My Family"
    ]);

    // Fernando
    const FERNANDO_PHONE = "558195977127@s.whatsapp.net";
    const FERNANDO_NAME  = "Fernando";

    // Maria Cecília
    const MARIA_PHONE = "INSIRA_O_ID_DE_WPP_AQUI@s.whatsapp.net"; // se quiser por JID
    const MARIA_NAME  = "Maria Cecília";

    const TAGS_RISK_HIGH = ["suicida", "autoagressao", "violencia"];
    const TAGS_RISK_MEDIUM = [
      "depressivo",
      "bullying",
      "sexual_inadequado",
      "controle_ciumento",
      "desrespeito"
    ];
    const TAGS_POSITIVE = ["apoio_positivo"];
    const HIGH_RISK_LABELS_FOR_CARD = ["suicida", "depressivo", "violencia", "autoagressao"];

    const RISK_LABELS_FOR_CHARTS = [
      "depressivo",
      "suicida",
      "autoagressao",
      "violencia",
      "desrespeito",
      "bullying",
      "sexual_inadequado",
      "controle_ciumento"
    ];
    const RISK_LABELS_SET = new Set(RISK_LABELS_FOR_CHARTS);

    const MIN_CTX_SCORE = 30;

    let riskMessagesGlobal = [];
    let currentRiskTagFilter = "";
    let currentRiskContactFilter = "";
    let currentRiskGroupFilter = "";

    let contextMessagesGlobal = [];
    let currentCtxTagFilter = "";
    let currentCtxContactFilter = "";
    let currentCtxGroupFilter = "";

    let allRowsGlobal = [];
    let rowByRowIdGlobal = {};

    // REGISTRO DOS GRÁFICOS
    const chartsRegistry = {};

    // Paleta de cores para TAGs
    const TAG_COLORS = {
      suicida: "#fb7185",
      depressivo: "#60a5fa",
      violencia: "#facc15",
      autoagressao: "#f97316",
      bullying: "#a855f7",
      sexual_inadequado: "#ec4899",
      controle_ciumento: "#22c55e",
      desrespeito: "#e5e7eb",
      total: "#38bdf8"
    };
    const FALLBACK_COLORS = [
      "#38bdf8", "#a855f7", "#22c55e", "#f97316",
      "#facc15", "#fb7185", "#e5e7eb", "#818cf8"
    ];

    function getColorForTag(tag, idx) {
      const key = String(tag || "").toLowerCase();
      if (TAG_COLORS[key]) return TAG_COLORS[key];
      return FALLBACK_COLORS[idx % FALLBACK_COLORS.length];
    }

    function isRiskLabelName(label) {
      return RISK_LABELS_SET.has(String(label || "").toLowerCase());
    }

    function parseLabels(str) {
      if (!str) return [];
      return String(str)
        .split(";")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function hasAnyLabel(labels, targetList) {
      const set = new Set(targetList.map(l => String(l).toLowerCase()));
      return labels.some(l => set.has(String(l).toLowerCase()));
    }

    function parseDate(str) {
      if (!str) return null;
      const d = new Date(str);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function classifyDirection(status) {
      const s = String(status || "").toLowerCase();
      if (!s) return "unknown";
      if (s.includes("enviad") || s.includes("sent")) return "sent";
      if (s.includes("recebid") || s.includes("received")) return "received";
      if (s.includes("apag") || s.includes("delet")) return "deleted";
      if (s.includes("edit")) return "edited";
      return "unknown";
    }

    async function fetchData() {
      const res = await fetch(API_URL);
      if (!res.ok) {
        console.error("Erro ao buscar dados:", res.status, await res.text());
        throw new Error("Falha ao buscar dados: " + res.status);
      }
      return await res.json();
    }

    function createTagSpan(label) {
      if (!label) return null;
      const normalized = String(label).toLowerCase();
      // Ocultar completamente TAG "ignorado"
      if (normalized === "ignorado") return null;

      const span = document.createElement("span");
      span.classList.add("tag");

      if (TAGS_RISK_HIGH.includes(label)) {
        span.classList.add("tag-risk");
      } else if (TAGS_RISK_MEDIUM.includes(label)) {
        span.classList.add("tag-medium");
      } else if (TAGS_POSITIVE.includes(label)) {
        span.classList.add("tag-low"); // verde / positivo
      } else {
        span.classList.add("tag-low");
      }

      span.textContent = label;
      return span;
    }

    function formatTopTagsHtml(tagCounts, maxTags = 4) {
      const container = document.createElement("span");
      const entries = Object.entries(tagCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, maxTags);

      if (!entries.length) {
        container.textContent = "nenhuma TAG registrada";
        return container;
      }

      entries.forEach(([label, count], idx) => {
        const tagSpan = createTagSpan(label);
        if (tagSpan) {
          tagSpan.textContent = `${label} (${count})`;
          container.appendChild(tagSpan);
        }
      });

      return container;
    }

    function showMessageModal({ whenStr, sender, chat, message, labels, summary }) {
      const modal = document.getElementById("messageModal");
      const metaEl = document.getElementById("modalMeta");
      const tagsEl = document.getElementById("modalTags");
      const summaryEl = document.getElementById("modalSummary");
      const textEl = document.getElementById("modalMessageText");

      metaEl.textContent = `${whenStr} · ${sender} · ${chat}`;
      tagsEl.innerHTML = "";
      (labels || []).forEach(label => {
        const tagSpan = createTagSpan(label);
        if (tagSpan) tagsEl.appendChild(tagSpan);
      });

      summaryEl.textContent = summary ? `Resumo (IA): ${summary}` : "";

      textEl.textContent = message || "";

      modal.classList.remove("hidden");
    }

    function closeMessageModal() {
      const modal = document.getElementById("messageModal");
      modal.classList.add("hidden");
    }

    function populateRiskTagFilter(riskMessages) {
      const select = document.getElementById("riskTagFilter");
      if (!select) return;

      const previous = select.value;
      const allTags = new Set();
      riskMessages.forEach(item => {
        (item.labels || []).forEach(l => {
          const norm = String(l).toLowerCase();
          if (norm === "ignorado") return;
          allTags.add(l);
        });
      });

      select.innerHTML = '<option value="">Todas</option>';
      Array.from(allTags)
        .sort()
        .forEach(tag => {
          const opt = document.createElement("option");
          opt.value = tag;
          opt.textContent = tag;
          select.appendChild(opt);
        });

      if (previous && allTags.has(previous)) {
        select.value = previous;
        currentRiskTagFilter = previous;
      } else {
        currentRiskTagFilter = "";
      }
    }

    function populateCtxTagFilter(contextMessages) {
      const select = document.getElementById("ctxTagFilter");
      if (!select) return;

      const previous = select.value;
      const allTags = new Set();
      contextMessages.forEach(item => {
        (item.labelsCtx || []).forEach(l => {
          const norm = String(l).toLowerCase();
          if (norm === "ignorado") return;
          allTags.add(l);
        });
      });

      select.innerHTML = '<option value="">Todas</option>';
      Array.from(allTags)
        .sort()
        .forEach(tag => {
          const opt = document.createElement("option");
          opt.value = tag;
          opt.textContent = tag;
          select.appendChild(opt);
        });

      if (previous && allTags.has(previous)) {
        select.value = previous;
        currentCtxTagFilter = previous;
      } else {
        currentCtxTagFilter = "";
      }
    }

    function populateSenderGroupFiltersFromMessages(messages, contactSelectId, groupSelectId) {
      const contactSelect = document.getElementById(contactSelectId);
      const groupSelect = document.getElementById(groupSelectId);
      if (!contactSelect || !groupSelect) return;

      const senders = new Set();
      const groups = new Set();

      messages.forEach(item => {
        const row = item.row;
        if (row.sender) senders.add(row.sender);
        if (row.group) groups.add(row.group);
      });

      contactSelect.innerHTML = '<option value="">Todos</option>';
      Array.from(senders)
        .sort((a, b) => mapName(a).localeCompare(mapName(b), "pt-BR"))
        .forEach(senderRaw => {
          const opt = document.createElement("option");
          opt.value = senderRaw;
          opt.textContent = mapName(senderRaw) || senderRaw;
          contactSelect.appendChild(opt);
        });

      groupSelect.innerHTML = '<option value="">Todos</option>';
      Array.from(groups)
        .sort((a, b) => mapName(a).localeCompare(mapName(b), "pt-BR"))
        .forEach(groupRaw => {
          const opt = document.createElement("option");
          opt.value = groupRaw;
          opt.textContent = mapName(groupRaw) || groupRaw;
          groupSelect.appendChild(opt);
        });
    }

    function renderRiskMessages(riskMessages, filterTag, contactFilter, groupFilter) {
      const tbodyRisk = document.querySelector("#riskMessagesTable tbody");
      if (!tbodyRisk) return;
      tbodyRisk.innerHTML = "";

      const filtered = riskMessages.filter(item => {
        const row = item.row;
        if (filterTag && !item.labels.includes(filterTag)) return false;
        if (contactFilter && row.sender !== contactFilter) return false;
        if (groupFilter && row.group !== groupFilter) return false;
        return true;
      });

      filtered.slice(0, 200).forEach(item => {
        const row = item.row;
        const d = parseDate(row.timestamp);
        const labels = item.labels || [];

        const whenStr = d
          ? d.toLocaleString("pt-BR", { hour12: false })
          : (row.timestamp || "");

        const tr = document.createElement("tr");

        const tdWhen = document.createElement("td");
        tdWhen.textContent = whenStr;

        const tdSender = document.createElement("td");
        tdSender.textContent = mapName(row.sender || "");

        const tdChat = document.createElement("td");
        tdChat.textContent = mapName(row.group || "");

        const tdMsg = document.createElement("td");

        const fullMessage = row.message || "";
        const displayMessage =
          fullMessage.length > 256 ? fullMessage.slice(0, 256) + "…" : fullMessage;

        const previewDiv = document.createElement("div");
        previewDiv.classList.add("message-preview");
        previewDiv.textContent = displayMessage || "[sem texto]";

        previewDiv.addEventListener("click", () => {
          showMessageModal({
            whenStr,
            sender: mapName(row.sender || ""),
            chat: mapName(row.group || ""),
            message: fullMessage,
            labels,
            summary: row.ia_summary || ""
          });
        });

        const tagsDiv = document.createElement("div");
        tagsDiv.style.marginTop = "4px";
        labels.forEach(label => {
          const tagSpan = createTagSpan(label);
          if (tagSpan) tagsDiv.appendChild(tagSpan);
        });

        const summary = row.ia_summary || "";
        if (summary) {
          const summaryDiv = document.createElement("div");
          summaryDiv.style.marginTop = "2px";
          summaryDiv.style.fontSize = "0.7rem";
          summaryDiv.style.color = "#9ca3af";
          summaryDiv.textContent = summary;
          tdMsg.appendChild(summaryDiv);
        }

        tdMsg.appendChild(previewDiv);
        tdMsg.appendChild(tagsDiv);

        tr.appendChild(tdWhen);
        tr.appendChild(tdSender);
        tr.appendChild(tdChat);
        tr.appendChild(tdMsg);

        tbodyRisk.appendChild(tr);
      });
    }

    function renderContextMessages(contextMessages, tagFilter, contactFilter, groupFilter) {
      const tbody = document.querySelector("#contextMessagesTable tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      const filtered = contextMessages.filter(item => {
        const row = item.row;
        if (tagFilter && !(item.labelsCtx || []).includes(tagFilter)) return false;
        if (contactFilter && row.sender !== contactFilter) return false;
        if (groupFilter && row.group !== groupFilter) return false;
        return true;
      });

      const sorted = filtered
        .slice()
        .sort((a, b) => (b.ctxScore || 0) - (a.ctxScore || 0));

      sorted.slice(0, 100).forEach(item => {
        const row = item.row;
        const d = parseDate(row.timestamp);

        const whenStr = d
          ? d.toLocaleString("pt-BR", { hour12: false })
          : (row.timestamp || "");

        const tr = document.createElement("tr");

        const tdWhen = document.createElement("td");
        tdWhen.textContent = whenStr;

        const tdSender = document.createElement("td");
        tdSender.textContent = mapName(row.sender || "");

        const tdChat = document.createElement("td");
        tdChat.textContent = mapName(row.group || "");

        const tdContext = document.createElement("td");

        const summaryText = row.ia_summary_ctx || row.ia_summary || "";
        const labelsCtx = item.labelsCtx || [];

        const previewDiv = document.createElement("div");
        previewDiv.classList.add("message-preview");
        previewDiv.textContent = summaryText || "[sem resumo de contexto]";

        const tagsDiv = document.createElement("div");
        tagsDiv.style.marginTop = "4px";
        labelsCtx.forEach(label => {
          const tagSpan = createTagSpan(label);
          if (tagSpan) tagsDiv.appendChild(tagSpan);
        });

        if (!item.ctxRowIds || !item.ctxRowIds.length) {
          const noCtxDiv = document.createElement("div");
          noCtxDiv.style.marginTop = "4px";
          noCtxDiv.style.fontSize = "0.7rem";
          noCtxDiv.style.color = "#9ca3af";
          noCtxDiv.textContent = "Sem contexto disponível";
          tdContext.appendChild(noCtxDiv);
        }

        previewDiv.addEventListener("click", () => {
          const ctxLines = [];
          const ctxIds = item.ctxRowIds || [];

          const targetRowId = String(
            row.rowid || row["#"] || row.id || ""
          ).replace(/\.0$/, "");

          ctxIds.forEach(idStr => {
            const cleanId = String(idStr).replace(/\.0$/, "");
            const ctxRow = rowByRowIdGlobal[cleanId];
            if (!ctxRow) return;

            const d2 = parseDate(ctxRow.timestamp);
            const when2 = d2
              ? d2.toLocaleString("pt-BR", { hour12: false })
              : (ctxRow.timestamp || "");
            const who2 = mapName(ctxRow.sender || "");
            const msg2 = ctxRow.message || "[sem texto]";
            const ctxRowId = String(
              ctxRow.rowid || ctxRow["#"] || ctxRow.id || ""
            ).replace(/\.0$/, "");

            let line = `${when2} · ${who2}: ${msg2}`;
            if (ctxRowId && targetRowId && ctxRowId === targetRowId) {
              line += "  (mensagem analisada)";
            }
            ctxLines.push(line);
          });

          const dialogText = ctxLines.length
            ? ctxLines.join("\n\n")
            : (row.message || "[sem mensagens de contexto encontradas]");

          showMessageModal({
            whenStr,
            sender: mapName(row.sender || ""),
            chat: mapName(row.group || ""),
            message: dialogText,
            labels: labelsCtx,
            summary: summaryText
          });
        });

        tdContext.appendChild(previewDiv);
        tdContext.appendChild(tagsDiv);

        tr.appendChild(tdWhen);
        tr.appendChild(tdSender);
        tr.appendChild(tdChat);
        tr.appendChild(tdContext);

        tbody.appendChild(tr);
      });

      console.log("Mensagens com contexto detectadas:", contextMessages.length, contextMessages);
    }

    // Helper para labels de datas no eixo X
    function formatDayKey(dayKey) {
      // espera "YYYY-MM-DD"
      const parts = String(dayKey).split("-");
      if (parts.length === 3) {
        return parts[2] + "/" + parts[1];
      }
      return dayKey;
    }

    // Converte mapa {dia:{tag:valor}} em labels + datasets do Chart.js
    function dailyTagMapToChartData(dailyMap) {
      const days = Object.keys(dailyMap).sort();
      const labels = days.map(formatDayKey);

      const tagSet = new Set();
      days.forEach(day => {
        Object.keys(dailyMap[day]).forEach(tag => tagSet.add(tag));
      });

      const datasets = Array.from(tagSet).sort().map((tag, idx) => {
        const data = days.map(day => dailyMap[day][tag] || 0);
        const color = getColorForTag(tag, idx);
        return {
          label: tag,
          data,
          tension: 0.3,
          fill: false,
          borderColor: color,
          backgroundColor: color,
          pointRadius: 2
        };
      });

      return { labels, datasets };
    }

    function upsertLineChart(chartKey, canvasId, labels, datasets, yAxisTitle) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext("2d");

      const baseConfig = {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              labels: { color: "#e5e7eb", font: { size: 10 } }
            },
            tooltip: {
              enabled: true
            }
          },
          scales: {
            x: {
              ticks: { color: "#9ca3af", maxRotation: 0 },
              grid: { display: false }
            },
            y: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(148,163,184,0.2)" },
              title: yAxisTitle
                ? {
                    display: true,
                    text: yAxisTitle,
                    color: "#9ca3af",
                    font: { size: 11 }
                  }
                : undefined
            }
          }
        }
      };

      if (chartsRegistry[chartKey]) {
        const chart = chartsRegistry[chartKey];
        chart.data.labels = labels;
        chart.data.datasets = datasets;
        chart.update();
      } else {
        chartsRegistry[chartKey] = new Chart(ctx, baseConfig);
      }
    }

    function updateDashboard(data) {
      const total = data.length;

      allRowsGlobal = data;
      rowByRowIdGlobal = {};

      const senderCount = {};
      const senderSet = new Set();
      const chatCountCombined = {};

      const tagCounts = {};
      const fernandoTagCounts = {};
      const mariaTagCounts = {};

      const offenderPerson = {};
      const offenderGroup = {};
      const supporterPerson = {};
      const supporterGroup = {};

      const highRiskContacts = {};

      let highRiskCount = 0;
      let suicidaCount = 0;
      let depressivoCount = 0;
      let violenciaCount = 0;
      let autoagressaoCount = 0;

      let fernandoTotal = 0;
      let fernandoRiskCount = 0;
      let fernandoPositiveCount = 0;

      let mariaTotal = 0;
      let mariaRiskCount = 0;
      let mariaPositiveCount = 0;

      const riskMessages = [];
      const contextMessages = [];

      const now = new Date();
      const todayKey = now.toISOString().slice(0, 10);

      let monthSent = 0;
      let monthReceived = 0;
      let todaySent = 0;
      let todayReceived = 0;

      let minDate = null;
      let maxDate = null;

      // Mapas diários para os gráficos
      const dailyTotals = {};
      const dailyHighRiskTags = {};
      const dailyFernandoRiskTags = {};
      const dailyMariaRiskTags = {};

      function sameMonthYear(d1, d2) {
        return (
          d1 &&
          d2 &&
          d1.getFullYear() === d2.getFullYear() &&
          d1.getMonth() === d2.getMonth()
        );
      }

      data.forEach(row => {
        const senderRaw = row.sender || "Desconhecido";
        const groupRaw  = row.group || "Sem grupo";
        const phone = row.phone || "";
        const status = row.status || "";

        const d = parseDate(row.timestamp);
        let dayKey = null;
        if (d) {
          if (!minDate || d < minDate) minDate = d;
          if (!maxDate || d > maxDate) maxDate = d;

          dayKey = d.toISOString().slice(0, 10);

          const dir = classifyDirection(status);

          if (sameMonthYear(d, now)) {
            if (dir === "sent") monthSent++;
            if (dir === "received") monthReceived++;
          }
          if (dayKey === todayKey) {
            if (dir === "sent") todaySent++;
            if (dir === "received") todayReceived++;
          }

          // total diário
          if (dayKey) {
            dailyTotals[dayKey] = (dailyTotals[dayKey] || 0) + 1;
          }
        }

        const rowIdRaw = row.rowid || row["#"] || row.id;
        if (rowIdRaw !== undefined && rowIdRaw !== null && rowIdRaw !== "") {
          const key = String(rowIdRaw).replace(/\.0$/, "");
          rowByRowIdGlobal[key] = row;
        }

        const senderLower = senderRaw.toLowerCase();
        const groupLower  = groupRaw.toLowerCase();

        senderSet.add(senderRaw);
        senderCount[senderRaw] = (senderCount[senderRaw] || 0) + 1;
        chatCountCombined[groupRaw] = (chatCountCombined[groupRaw] || 0) + 1;

        const riskScore = Number(row.ia_risk_score || 0);
        const labels = parseLabels(row.ia_labels);

        labels.forEach(label => {
          const norm = String(label).toLowerCase();
          if (norm === "ignorado") return;
          tagCounts[label] = (tagCounts[label] || 0) + 1;
        });

        const isDepressive = labels.includes("depressivo");
        const isSuicidal   = labels.includes("suicida");
        const isSelfHarm   = labels.includes("autoagressao");
        const isViolent    = labels.includes("violencia");
        const isHighRisk   = riskScore >= 70 || isSuicidal || isSelfHarm;

        if (isSuicidal) suicidaCount++;
        if (isDepressive) depressivoCount++;
        if (isViolent) violenciaCount++;
        if (isSelfHarm) autoagressaoCount++;

        const isRiskLabel = hasAnyLabel(labels, [
          "depressivo","suicida","autoagressao","violencia",
          "desrespeito","bullying","sexual_inadequado","controle_ciumento"
        ]);
        const isPositive  = labels.includes("apoio_positivo");

        if (isHighRisk) {
          highRiskCount++;
          if (dayKey) {
            if (!dailyHighRiskTags[dayKey]) dailyHighRiskTags[dayKey] = {};
            HIGH_RISK_LABELS_FOR_CARD.forEach(tag => {
              if (labels.includes(tag)) {
                dailyHighRiskTags[dayKey][tag] =
                  (dailyHighRiskTags[dayKey][tag] || 0) + 1;
              }
            });
          }
        }

        if (hasAnyLabel(labels, HIGH_RISK_LABELS_FOR_CARD)) {
          highRiskContacts[senderRaw] = (highRiskContacts[senderRaw] || 0) + 1;
        }

        const isFernando =
          phone === FERNANDO_PHONE ||
          senderLower.includes(FERNANDO_NAME.toLowerCase()) ||
          groupLower.includes(FERNANDO_NAME.toLowerCase());

        const isMaria =
          phone === MARIA_PHONE ||
          senderLower.includes(MARIA_NAME.toLowerCase()) ||
          groupLower.includes(MARIA_NAME.toLowerCase());

        if (isFernando) {
          fernandoTotal++;
          if (isRiskLabel) fernandoRiskCount++;
          if (isPositive)  fernandoPositiveCount++;
          labels.forEach(label => {
            const norm = String(label).toLowerCase();
            if (norm === "ignorado") return;
            fernandoTagCounts[label] = (fernandoTagCounts[label] || 0) + 1;
          });

          if (dayKey && isRiskLabel) {
            if (!dailyFernandoRiskTags[dayKey]) dailyFernandoRiskTags[dayKey] = {};
            labels.forEach(l => {
              if (!isRiskLabelName(l)) return;
              const key = String(l).toLowerCase();
              dailyFernandoRiskTags[dayKey][key] =
                (dailyFernandoRiskTags[dayKey][key] || 0) + 1;
            });
          }
        }

        if (isMaria) {
          mariaTotal++;
          if (isRiskLabel) mariaRiskCount++;
          if (isPositive)  mariaPositiveCount++;
          labels.forEach(label => {
            const norm = String(label).toLowerCase();
            if (norm === "ignorado") return;
            mariaTagCounts[label] = (mariaTagCounts[label] || 0) + 1;
          });

          if (dayKey && isRiskLabel) {
            if (!dailyMariaRiskTags[dayKey]) dailyMariaRiskTags[dayKey] = {};
            labels.forEach(l => {
              if (!isRiskLabelName(l)) return;
              const key = String(l).toLowerCase();
              dailyMariaRiskTags[dayKey][key] =
                (dailyMariaRiskTags[dayKey][key] || 0) + 1;
            });
          }
        }

        if (isRiskLabel) {
          offenderPerson[senderRaw] = offenderPerson[senderRaw] || { count: 0, tags: {} };
          offenderPerson[senderRaw].count++;
          labels.forEach(l => {
            const norm = String(l).toLowerCase();
            if (norm === "ignorado") return;
            offenderPerson[senderRaw].tags[l] =
              (offenderPerson[senderRaw].tags[l] || 0) + 1;
          });

          offenderGroup[groupRaw] = offenderGroup[groupRaw] || { count: 0, tags: {} };
          offenderGroup[groupRaw].count++;
          labels.forEach(l => {
            const norm = String(l).toLowerCase();
            if (norm === "ignorado") return;
            offenderGroup[groupRaw].tags[l] =
              (offenderGroup[groupRaw].tags[l] || 0) + 1;
          });
        }

        if (isPositive) {
          supporterPerson[senderRaw] = supporterPerson[senderRaw] || { count: 0, tags: {} };
          supporterPerson[senderRaw].count++;
          labels.forEach(l => {
            const norm = String(l).toLowerCase();
            if (norm === "ignorado") return;
            supporterPerson[senderRaw].tags[l] =
              (supporterPerson[senderRaw].tags[l] || 0) + 1;
          });

          supporterGroup[groupRaw] = supporterGroup[groupRaw] || { count: 0, tags: {} };
          supporterGroup[groupRaw].count++;
          labels.forEach(l => {
            const norm = String(l).toLowerCase();
            if (norm === "ignorado") return;
            supporterGroup[groupRaw].tags[l] =
              (supporterGroup[groupRaw].tags[l] || 0) + 1;
          });
        }

        const isModerateOrHigh =
          riskScore >= 50 ||
          hasAnyLabel(labels, [
            "depressivo","suicida","autoagressao","violencia",
            "desrespeito","bullying","sexual_inadequado","controle_ciumento"
          ]);

        if (isModerateOrHigh) {
          riskMessages.push({
            row,
            score: riskScore,
            labels
          });
        }

        // CONTEXTO
        const ctxScore   = Number(row.ia_risk_score_ctx || 0);
        const ctxLabels  = parseLabels(row.ia_labels_ctx);
        const ctxSummary = row.ia_summary_ctx || "";
        const ctxRowStr  = row.ia_ctx_rowids || "";

        const hasCtxRowIds = String(ctxRowStr || "")
          .split(/[,\s]+/)
          .map(s => s.trim())
          .filter(Boolean).length > 0;

        if (ctxScore >= MIN_CTX_SCORE || ctxLabels.length || ctxSummary || hasCtxRowIds) {
          const ctxRowIds = String(ctxRowStr || "")
            .split(/[,\s]+/)
            .map(s => s.trim())
            .filter(Boolean)
            .map(s => s.replace(/\.0$/, ""));

          contextMessages.push({
            row,
            labelsCtx: ctxLabels,
            ctxScore,
            ctxRowIds
          });
        }
      });

      // Separação grupo x DM
      const groupCount = {};
      const dmCount = {};

      Object.entries(chatCountCombined).forEach(([chatName, count]) => {
        if (!chatName || chatName === "Sem grupo") return;

        if (FORCE_GROUP.has(chatName)) {
          groupCount[chatName] = count;
          return;
        }

        const lowered = chatName.toLowerCase();
        const isGroupById = lowered.includes("@g.us");
        const isDmById    = lowered.includes("@lid");

        if (isGroupById) {
          groupCount[chatName] = count;
        } else if (isDmById) {
          dmCount[chatName] = count;
        } else {
          if (senderSet.has(chatName)) {
            dmCount[chatName] = count;
          } else {
            groupCount[chatName] = count;
          }
        }
      });

      // Cards principais
      document.getElementById("totalMessages").textContent = total.toString();
      const uniqueChats = new Set([
        ...Object.keys(groupCount),
        ...Object.keys(dmCount)
      ]);
      document.getElementById("uniqueSenders").textContent =
        Object.keys(senderCount).length.toString();
      document.getElementById("uniqueGroups").textContent =
        uniqueChats.size.toString();

      document.getElementById("monthSent").textContent = monthSent.toString();
      document.getElementById("monthReceived").textContent = monthReceived.toString();
      document.getElementById("todaySent").textContent = todaySent.toString();
      document.getElementById("todayReceived").textContent = todayReceived.toString();

      document.getElementById("highRiskCount").textContent =
        highRiskCount.toString();

      // TAGs de alto risco (suicida/depressivo/violencia/autoagressao)
      const highRiskTagsSummaryEl = document.getElementById("highRiskTagsSummary");
      if (highRiskTagsSummaryEl) {
        highRiskTagsSummaryEl.innerHTML = "";
        const info = [
          ["suicida", suicidaCount],
          ["depressivo", depressivoCount],
          ["violencia", violenciaCount],
          ["autoagressao", autoagressaoCount]
        ];
        info.forEach(([label, count]) => {
          const tagSpan = createTagSpan(label);
          if (tagSpan) {
            tagSpan.textContent = `${label} (${count})`;
            highRiskTagsSummaryEl.appendChild(tagSpan);
          }
        });
      }

      document.getElementById("fernandoTotal").textContent =
        fernandoTotal.toString();
      document.getElementById("fernandoRiskCount").textContent =
        fernandoRiskCount.toString();
      document.getElementById("fernandoPositiveCount").textContent =
        fernandoPositiveCount.toString();

      const fernandoTagsSummaryEl =
        document.getElementById("fernandoTagsSummary");
      fernandoTagsSummaryEl.innerHTML = "";
      fernandoTagsSummaryEl.appendChild(
        formatTopTagsHtml(fernandoTagCounts)
      );

      document.getElementById("mariaTotal").textContent =
        mariaTotal.toString();
      document.getElementById("mariaRiskCount").textContent =
        mariaRiskCount.toString();
      document.getElementById("mariaPositiveCount").textContent =
        mariaPositiveCount.toString();

      const mariaTagsSummaryEl = document.getElementById("mariaTagsSummary");
      mariaTagsSummaryEl.innerHTML = "";
      mariaTagsSummaryEl.appendChild(formatTopTagsHtml(mariaTagCounts));

      // Card "Última atualização"
      const lastUpdateEl = document.getElementById("lastUpdate");
      const dateRangeEl = document.getElementById("dateRange");
      if (lastUpdateEl) {
        lastUpdateEl.textContent =
          now.toLocaleString("pt-BR", { hour12: false });
      }
      if (dateRangeEl) {
        if (minDate && maxDate) {
          const fmt = d =>
            d.toLocaleDateString("pt-BR", {
              day: "numeric",
              month: "short",
              year: "numeric"
            });
          dateRangeEl.textContent =
            "Mensagens entre " + fmt(minDate) + " e " + fmt(maxDate);
        } else {
          dateRangeEl.textContent = "Intervalo de datas não disponível";
        }
      }

      // Função auxiliar para pegar top
      function pickTop(mapObj) {
        let bestKey = null;
        let best = null;
        Object.entries(mapObj).forEach(([key, value]) => {
          if (!best || value.count > best.count) {
            bestKey = key;
            best = value;
          }
        });
        return bestKey ? { key: bestKey, ...best } : null;
      }

      const offenderGroupOnly = {};
      Object.entries(offenderGroup).forEach(([chat, dataVal]) => {
        if (groupCount[chat]) {
          offenderGroupOnly[chat] = dataVal;
        }
      });

      const supporterGroupOnly = {};
      Object.entries(supporterGroup).forEach(([chat, dataVal]) => {
        if (groupCount[chat]) {
          supporterGroupOnly[chat] = dataVal;
        }
      });

      const topOffenderPerson   = pickTop(offenderPerson);
      const topOffenderGroup    = pickTop(offenderGroupOnly);
      const topSupporterPerson  = pickTop(supporterPerson);

      // Para grupos de apoio positivo, vamos pegar array ordenado
      const supporterGroupsArray = Object.entries(supporterGroupOnly)
        .sort((a, b) => b[1].count - a[1].count);

      const topSupporterGroup =
        supporterGroupsArray.length > 0
          ? { key: supporterGroupsArray[0][0], ...supporterGroupsArray[0][1] }
          : null;

      let secondSupporterGroup = null;
      // Primeiro, tenta achar explicitamente "My Family"
      for (const [key, val] of supporterGroupsArray) {
        const mapped = mapName(key) || key;
        if (mapped === "My Family") {
          secondSupporterGroup = { key, ...val };
          break;
        }
      }
      // Se não achar My Family, pega o segundo da lista
      if (!secondSupporterGroup && supporterGroupsArray.length > 1) {
        secondSupporterGroup = {
          key: supporterGroupsArray[1][0],
          ...supporterGroupsArray[1][1]
        };
      }

      if (topOffenderPerson) {
        document.getElementById("topOffenderName").textContent =
          mapName(topOffenderPerson.key);
        document.getElementById("topOffenderRiskCount").textContent =
          topOffenderPerson.count.toString();
        const el = document.getElementById("topOffenderTags");
        el.innerHTML = "";
        el.appendChild(formatTopTagsHtml(topOffenderPerson.tags));
      }

      if (topOffenderGroup) {
        document.getElementById("topOffenderGroupName").textContent =
          mapName(topOffenderGroup.key);
        document.getElementById("topOffenderGroupRiskCount").textContent =
          topOffenderGroup.count.toString();
        const el = document.getElementById("topOffenderGroupTags");
        el.innerHTML = "";
        el.appendChild(formatTopTagsHtml(topOffenderGroup.tags));
      }

      if (topSupporterPerson) {
        document.getElementById("topSupporterName").textContent =
          mapName(topSupporterPerson.key);
        document.getElementById("topSupporterPositiveCount").textContent =
          topSupporterPerson.count.toString();
        const el = document.getElementById("topSupporterTags");
        el.innerHTML = "";
        el.appendChild(formatTopTagsHtml(topSupporterPerson.tags));
      }

      if (topSupporterGroup) {
        document.getElementById("topSupporterGroupName").textContent =
          mapName(topSupporterGroup.key);
        document.getElementById("topSupporterGroupPositiveCount").textContent =
          topSupporterGroup.count.toString();
        const el = document.getElementById("topSupporterGroupTags");
        el.innerHTML = "";
        el.appendChild(formatTopTagsHtml(topSupporterGroup.tags));
      }

      if (secondSupporterGroup) {
        document.getElementById("secondSupporterGroupName").textContent =
          mapName(secondSupporterGroup.key);
        document.getElementById("secondSupporterGroupPositiveCount").textContent =
          secondSupporterGroup.count.toString();
        const el = document.getElementById("secondSupporterGroupTags");
        el.innerHTML = "";
        el.appendChild(formatTopTagsHtml(secondSupporterGroup.tags));
      }

      // Card 5+ Mensageiros de alto risco
      const highRiskContactsEl = document.getElementById("highRiskContacts");
      if (highRiskContactsEl) {
        highRiskContactsEl.innerHTML = "";
        const entries = Object.entries(highRiskContacts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        if (!entries.length) {
          highRiskContactsEl.textContent = "nenhum contato recorrente";
        } else {
          entries.forEach(([name, count], idx) => {
            const div = document.createElement("div");
            div.textContent = `${idx + 1}. ${mapName(name) || name} (${count})`;
            highRiskContactsEl.appendChild(div);
          });
        }
      }

      // Top remetentes
      const sendersArray = Object.entries(senderCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      const tbodySenders = document.querySelector("#topSendersTable tbody");
      tbodySenders.innerHTML = "";
      sendersArray.forEach(([name, count]) => {
        const tr = document.createElement("tr");
        const pct = total ? ((count / total) * 100).toFixed(1) : "0.0";
        tr.innerHTML = `
          <td>${mapName(name)}</td>
          <td>${count}</td>
          <td>${pct}%</td>
        `;
        tbodySenders.appendChild(tr);
      });

      // Top grupos
      const groupsArray = Object.entries(groupCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      const tbodyGroups = document.querySelector("#topGroupsTable tbody");
      tbodyGroups.innerHTML = "";
      groupsArray.forEach(([name, count]) => {
        const tr = document.createElement("tr");
        const pct = total ? ((count / total) * 100).toFixed(1) : "0.0";
        tr.innerHTML = `
          <td>${mapName(name)}</td>
          <td>${count}</td>
          <td>${pct}%</td>
        `;
        tbodyGroups.appendChild(tr);
      });

      // Top DMs
      const dmsArray = Object.entries(dmCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      const tbodyDMs = document.querySelector("#topDMsTable tbody");
      tbodyDMs.innerHTML = "";
      dmsArray.forEach(([name, count]) => {
        const tr = document.createElement("tr");
        const pct = total ? ((count / total) * 100).toFixed(1) : "0.0";
        tr.innerHTML = `
          <td>${mapName(name)}</td>
          <td>${count}</td>
          <td>${pct}%</td>
        `;
        tbodyDMs.appendChild(tr);
      });

      // Mensagens de maior risco
      riskMessages.sort((a, b) => b.score - a.score);
      riskMessagesGlobal = riskMessages;

      populateRiskTagFilter(riskMessagesGlobal);
      populateSenderGroupFiltersFromMessages(
        riskMessagesGlobal,
        "riskContactFilter",
        "riskGroupFilter"
      );
      renderRiskMessages(
        riskMessagesGlobal,
        currentRiskTagFilter,
        currentRiskContactFilter,
        currentRiskGroupFilter
      );

      // Mensagens em contexto
      contextMessagesGlobal = contextMessages;
      populateCtxTagFilter(contextMessagesGlobal);
      populateSenderGroupFiltersFromMessages(
        contextMessagesGlobal,
        "ctxContactFilter",
        "ctxGroupFilter"
      );
      renderContextMessages(
        contextMessagesGlobal,
        currentCtxTagFilter,
        currentCtxContactFilter,
        currentCtxGroupFilter
      );

      // Distribuição de TAGs
      const tbodyTags = document.querySelector("#tagDistributionTable tbody");
      if (tbodyTags) {
        tbodyTags.innerHTML = "";
        const tagsArray = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
        tagsArray.forEach(([tag, count]) => {
          const tr = document.createElement("tr");
          const pct = total ? ((count / total) * 100).toFixed(1) : "0.0";
          const tdTag = document.createElement("td");
          const badge = createTagSpan(tag);
          if (badge) tdTag.appendChild(badge);

          const tdCount = document.createElement("td");
          tdCount.textContent = count.toString();

          const tdPct = document.createElement("td");
          tdPct.textContent = pct + "%";

          tr.appendChild(tdTag);
          tr.appendChild(tdCount);
          tr.appendChild(tdPct);
          tbodyTags.appendChild(tr);
        });
      }

      // =========================
      //   CONSTRUÇÃO DOS GRÁFICOS
      // =========================

      // 1) Total de mensagens
      const dailyTotalsWrapped = {};
      Object.keys(dailyTotals).forEach(day => {
        dailyTotalsWrapped[day] = { total: dailyTotals[day] };
      });
      if (Object.keys(dailyTotalsWrapped).length) {
        const { labels, datasets } = dailyTagMapToChartData(dailyTotalsWrapped);
        datasets.forEach(ds => { ds.label = "Total"; });
        upsertLineChart("chartTotalMessages", "chartTotalMessages", labels, datasets, "Mensagens por dia");
      }

      // 2) Riscos altos / suicidas & depressivos
      if (Object.keys(dailyHighRiskTags).length) {
        const { labels, datasets } = dailyTagMapToChartData(dailyHighRiskTags);
        upsertLineChart("chartHighRiskTags", "chartHighRiskTags", labels, datasets, "Mensagens de alto risco por dia");
      }

      // 3) 4) Fernando / Maria – mapas já montados (contagem de mensagens de risco por TAG)
      if (Object.keys(dailyFernandoRiskTags).length) {
        const { labels, datasets } = dailyTagMapToChartData(dailyFernandoRiskTags);
        upsertLineChart("chartFernando", "chartFernando", labels, datasets, "Mensagens de risco por dia");
      }

      if (Object.keys(dailyMariaRiskTags).length) {
        const { labels, datasets } = dailyTagMapToChartData(dailyMariaRiskTags);
        upsertLineChart("chartMaria", "chartMaria", labels, datasets, "Mensagens de risco por dia");
      }

      // 5) 6) Maior ofensor individual / Grupo com mais ofensas
      const dailyTopOffenderTags = {};
      const dailyTopOffenderGroupTags = {};

      if (topOffenderPerson || topOffenderGroup) {
        data.forEach(row => {
          const d = parseDate(row.timestamp);
          if (!d) return;
          const dayKey = d.toISOString().slice(0, 10);
          const labels = parseLabels(row.ia_labels);
          const isRisk = hasAnyLabel(labels, [
            "depressivo","suicida","autoagressao","violencia",
            "desrespeito","bullying","sexual_inadequado","controle_ciumento"
          ]);
          if (!isRisk) return;

          if (topOffenderPerson && row.sender === topOffenderPerson.key) {
            if (!dailyTopOffenderTags[dayKey]) dailyTopOffenderTags[dayKey] = {};
            labels.forEach(l => {
              if (!isRiskLabelName(l)) return;
              const key = String(l).toLowerCase();
              dailyTopOffenderTags[dayKey][key] =
                (dailyTopOffenderTags[dayKey][key] || 0) + 1;
            });
          }

          if (topOffenderGroup && row.group === topOffenderGroup.key) {
            if (!dailyTopOffenderGroupTags[dayKey]) dailyTopOffenderGroupTags[dayKey] = {};
            labels.forEach(l => {
              if (!isRiskLabelName(l)) return;
              const key = String(l).toLowerCase();
              dailyTopOffenderGroupTags[dayKey][key] =
                (dailyTopOffenderGroupTags[dayKey][key] || 0) + 1;
            });
          }
        });
      }

      if (Object.keys(dailyTopOffenderTags).length) {
        const { labels, datasets } = dailyTagMapToChartData(dailyTopOffenderTags);
        upsertLineChart("chartTopOffender", "chartTopOffender", labels, datasets, "Mensagens de risco por dia");
      }

      if (Object.keys(dailyTopOffenderGroupTags).length) {
        const { labels, datasets } = dailyTagMapToChartData(dailyTopOffenderGroupTags);
        upsertLineChart("chartTopOffenderGroup", "chartTopOffenderGroup", labels, datasets, "Mensagens de risco por dia");
      }

      // 7) Mensagens com maior risco (IA) – soma diária dos scores por TAG
      const dailyRiskScores = {};
      riskMessagesGlobal.forEach(item => {
        const row = item.row;
        const d = parseDate(row.timestamp);
        if (!d) return;
        const dayKey = d.toISOString().slice(0, 10);
        const score = Number(item.score || 0);
        if (!score) return;
        const labels = item.labels || [];
        labels.forEach(l => {
          if (!isRiskLabelName(l)) return;
          const key = String(l).toLowerCase();
          if (!dailyRiskScores[dayKey]) dailyRiskScores[dayKey] = {};
          dailyRiskScores[dayKey][key] =
            (dailyRiskScores[dayKey][key] || 0) + score;
        });
      });

      if (Object.keys(dailyRiskScores).length) {
        const { labels, datasets } = dailyTagMapToChartData(dailyRiskScores);
        upsertLineChart("chartRiskScores", "chartRiskScores", labels, datasets, "Soma dos scores por dia");
      }

      // 8) Mensagens com maior risco em contexto (IA) – soma diária dos scores por TAG
      const dailyCtxScores = {};
      contextMessagesGlobal.forEach(item => {
        const row = item.row;
        const d = parseDate(row.timestamp);
        if (!d) return;
        const dayKey = d.toISOString().slice(0, 10);
        const score = Number(item.ctxScore || 0);
        if (!score) return;
        const labelsCtx = item.labelsCtx || [];
        labelsCtx.forEach(l => {
          if (!isRiskLabelName(l)) return;
          const key = String(l).toLowerCase();
          if (!dailyCtxScores[dayKey]) dailyCtxScores[dayKey] = {};
          dailyCtxScores[dayKey][key] =
            (dailyCtxScores[dayKey][key] || 0) + score;
        });
      });

      if (Object.keys(dailyCtxScores).length) {
        const { labels, datasets } = dailyTagMapToChartData(dailyCtxScores);
        upsertLineChart("chartCtxScores", "chartCtxScores", labels, datasets, "Soma dos scores de contexto por dia");
      }
    }

    async function refresh() {
      try {
        const data = await fetchData();
        updateDashboard(data);
      } catch (e) {
        console.error("Erro no refresh:", e);
      }
    }

    document.getElementById("modalCloseBtn").addEventListener("click", closeMessageModal);
    document.getElementById("messageModal").addEventListener("click", (e) => {
      if (e.target.id === "messageModal") {
        closeMessageModal();
      }
    });

    const riskTagFilterSelect = document.getElementById("riskTagFilter");
    riskTagFilterSelect.addEventListener("change", () => {
      currentRiskTagFilter = riskTagFilterSelect.value;
      renderRiskMessages(
        riskMessagesGlobal,
        currentRiskTagFilter,
        currentRiskContactFilter,
        currentRiskGroupFilter
      );
    });

    const riskContactFilterSelect = document.getElementById("riskContactFilter");
    const riskGroupFilterSelect = document.getElementById("riskGroupFilter");
    riskContactFilterSelect.addEventListener("change", () => {
      currentRiskContactFilter = riskContactFilterSelect.value;
      renderRiskMessages(
        riskMessagesGlobal,
        currentRiskTagFilter,
        currentRiskContactFilter,
        currentRiskGroupFilter
      );
    });
    riskGroupFilterSelect.addEventListener("change", () => {
      currentRiskGroupFilter = riskGroupFilterSelect.value;
      renderRiskMessages(
        riskMessagesGlobal,
        currentRiskTagFilter,
        currentRiskContactFilter,
        currentRiskGroupFilter
      );
    });

    const ctxTagFilterSelect = document.getElementById("ctxTagFilter");
    const ctxContactFilterSelect = document.getElementById("ctxContactFilter");
    const ctxGroupFilterSelect = document.getElementById("ctxGroupFilter");

    ctxTagFilterSelect.addEventListener("change", () => {
      currentCtxTagFilter = ctxTagFilterSelect.value;
      renderContextMessages(
        contextMessagesGlobal,
        currentCtxTagFilter,
        currentCtxContactFilter,
        currentCtxGroupFilter
      );
    });

    ctxContactFilterSelect.addEventListener("change", () => {
      currentCtxContactFilter = ctxContactFilterSelect.value;
      renderContextMessages(
        contextMessagesGlobal,
        currentCtxTagFilter,
        currentCtxContactFilter,
        currentCtxGroupFilter
      );
    });
    ctxGroupFilterSelect.addEventListener("change", () => {
      currentCtxGroupFilter = ctxGroupFilterSelect.value;
      renderContextMessages(
        contextMessagesGlobal,
        currentCtxTagFilter,
        currentCtxContactFilter,
        currentCtxGroupFilter
      );
    });

    refresh();
    setInterval(refresh, 60000);
  </script>
</body>
</html>
